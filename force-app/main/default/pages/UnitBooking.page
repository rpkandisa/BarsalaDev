<apex:page title="Unit Booking Wizard" id="pgId" controller="UnitBookingController" showHeader="{!if($User.UIThemeDisplayed == 'Theme4t', false,true)}" sidebar="false" docType="html-5.0" cache="false" action="{!validateUser}">
    <apex:slds />
    <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
    <!-- oncontextmenu="return false" -->

        <head>
            <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.fancybox,'/fancybox/jquery.fancybox.min.css')}" />

            <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.slickslider,'slick/slick.css')}"/>
            <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.slickslider,'slick/slick-theme.css')}"/>

            <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.starrating,'scripts/rateit.css')}"/>

        </head>
        <script src="https://js.stripe.com/v3/"></script>
        
        <link href="{!URLFOR($Resource.fonts,'fonts.css')}" rel="stylesheet" />
        
        <!--<apex:stylesheet value="{!URLFOR($Resource.lightning, '/assets/styles/salesforce-lightning-design-system-vf.min.css')}"/>
        -->
        <apex:variable value="{!if($User.UIThemeDisplayed == 'Theme4t', true,false)}" var="UserisOnSalesforce1"/>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge"/>
        <meta name="viewport" content="width=device-width, initial-scale=1,minimum-scale=1, maximum-scale=1, user-scalable=no"/>
        <!--<apex:includeScript value="{!URLFOR($Resource.SLCA2__jQuery, '/jquery.min.js')}"/>-->
        
        <apex:outputPanel rendered="{!UserisOnSalesforce1}">
            <script> 
                (function(){
                    try{
                        var a=navigator.userAgent; 
                        if((a.indexOf('Salesforce')!=-1)&&(a.indexOf('iPhone')!=-1||a.indexOf('iPad')!=-1)){
                            var s=document.createElement('style'); 
                            s.innerHTML="html,html body{overflow: auto;-webkit-overflow-scrolling:touch;}body{position:absolute;left:0;right:0;top:0;bottom:0;}"; 
                            document.getElementsByTagName('head')[0].appendChild(s);
                        }
                    }catch(e){}
                })(); 
            </script>
            
            <style>
                body {
                    background-color:white !important;
                }
                .slds-scope .slds-list--horizontal .slds-item--label {
                    width:50% !important;
                }
                .slds-scope .slds-list--horizontal .slds-item--detail {
                    width:50% !important;
                }
                
                .slds-scope .slds-notify--toast, .slds-scope .slds-notify_toast {
                    min-width:15rem !important;
                    margin-left:0px;
                }
                #guestMessagePanel {
                    <!--height:6rem !important;-->
                }
                /*.slds-datepicker {
                    <!--position: relative !important;-->
                }*/
                .slds-datepicker.slds-dropdown.slds-dropdown--left {
                    position: absolute !important;
                }     
                
                #ulavailableunits,#bookingContent,#paymentContent { margin:0 0 50px 0; }
                
                @media (max-device-width : 400px) {
                    .btnNextToPayment {
                        margin-left:0px !important; 
                        margin-top:5px !important;
                        margin-bottom:10px !important;
                    }
                }
            </style>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!$User.UIThemeDisplayed == 'Theme4d' || (!userModel.isStandardUser && $User.UIThemeDisplayed == 'Theme3')}">
            <style>
                .slds-input-has-icon .slds-input__icon {
                    fill: #54698d !important;
                }
                .hasMotif.homeTab.sfdcBody.brandQuaternaryBgr.slds-scope { background:#fff !important; }
                .slds-datepicker.slds-dropdown.slds-dropdown--left {
                    position: absolute !important;
                } 
                dt.slds-item--label.slds-text-color--weak {
                    padding-right: 0!important;
                }
                
                html, body { height: 95%; /*overflow-y: hidden !important;*/ }
                
                /* html .brandQuaternaryBgr {background:#fff !important;}
                html body.sfdcBody{overflow-y:-webkit-paged-y !important;} */
                /*.slds-datepicker {
                    position: relative !important;
                }
                */
            </style>
        </apex:outputPanel>
        <apex:outputPanel rendered="{! userModel.isStandardUser && $User.UIThemeDisplayed == 'Theme3'}">
            <style>
                .slds-input-has-icon .slds-input__icon {
                    fill: #54698d !important;
                }
                .slds-scope .brandQuaternaryBgr {background:#fff !important;}
            </style>
        </apex:outputPanel>
        <!--<apex:outputPanel rendered="{!$User.UIThemeDisplayed == 'Theme3'}">
            <style>
                .slds-input-has-icon .slds-input__icon {
                    fill: #54698d !important;
                }
                /*.slds-datepicker {
                    <!-position: relative !important;->
                }*/
            </style>
        </apex:outputPanel>-->
        
        <body class="scroll-pane" >
            <apex:outputPanel rendered="{! !userModel.isStandardUser && !userModel.isBookingAllowed}">
                <div id="permissionErrorPanel" style="height: 4rem;">
                    <div class="slds-notify_container slds-is-relative">
                        <div class="slds-theme_error slds-notify slds-notify_toast slds-size--1-of-1 slds-medium-size--4-of-5" role="alert">
                            <span class="slds-theme_error slds-assistive-text">error</span>
                            <span class="slds-icon_container slds-icon-utility-error slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                    <use id="guestMessageIcon" xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#error')}" />
                                </svg>
                            </span>
                            <div class="slds-notify__content">
                                <h2 class="slds-text-heading_small">Currently you do not have permissions to make booking using this wizard. <b>Please contact customer support at +1 (206) 800-7277 | sales@barsala.com.</b></h2>
                            </div>
                        </div>
                    </div>
                </div>
            </apex:outputPanel>
            <apex:outputPanel rendered="{! userModel.isStandardUser || userModel.isBookingAllowed}">
            <div class="slds slds-scope" style="{!if(UserisOnSalesforce1,'padding:10px;','')}">
                <!-- page header -->
                <div class="slds-page-header">
                    <div class="slds-grid">
                        <div class="slds-col slds-has-flexi-truncate">
                            <div class="slds-media slds-no-space slds-grow">
                                <!--<div class="slds-media__figure">
                                    <svg class="slds-icon slds-icon-custom-custom32" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.lightning, "/assets/icons/custom-sprite/svg/symbols.svg#custom32")}"></use>
                                    </svg>
                                </div>-->
                                <div class="slds-media__body">
                                    <p class="slds-text-title--caps slds-line-height--reset" style="font-family: Lato Light;">Unit</p>
                                    <h1 class="slds-page-header__title slds-m-right--small slds-truncate" title="Unit Booking Wizard">Unit Booking Wizard</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--Processbar for Unit Booking--> 
                <!--Hide progressbar when we are SF1-->
                <apex:outputPanel rendered="{!!UserisOnSalesforce1}">
                    <div class="slds-grid" style="margin-top:10px;">
                        <div class="slds-tabs--path" role="application">
                            <ul class="slds-tabs--path__nav" role="tablist">
                                <li class="slds-tabs--path__item slds-is-current" role="presentation">
                                    <a class="slds-tabs--path__link" id="search" aria-controls="content-path-1" aria-selected="false" 
                                            tabindex="-1" role="tab" href="javascript:void(0);" aria-live="assertive">
                                        <span class="slds-tabs--path__stage">
                                            <svg class="slds-icon slds-icon--x-small" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Resource.lightning, "/assets/icons/utility-sprite/svg/symbols.svg#check")}"></use>
                                            </svg>
                                            <span class="slds-assistive-text">Stage Complete</span>
                                        </span>
                                        <span class="slds-tabs--path__title">Search Unit</span>
                                    </a>
                                </li>
                                <li class="slds-tabs--path__item slds-is-incomplete" role="presentation">
                                    <a class="slds-tabs--path__link" id="booking" aria-controls="content-path-1" aria-selected="false" tabindex="-1" role="tab" href="javascript:void(0);" aria-live="assertive">
                                        <span class="slds-tabs--path__stage">
                                            <svg class="slds-icon slds-icon--x-small" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Resource.lightning, "/assets/icons/utility-sprite/svg/symbols.svg#check")}"></use>
                                            </svg>
                                            <span class="slds-assistive-text">Stage Complete</span>
                                        </span>
                                        <span class="slds-tabs--path__title">Booking Information</span>
                                    </a>
                                </li>
                                <li class="slds-tabs--path__item slds-is-incomplete" role="presentation">
                                    <a class="slds-tabs--path__link" id="payment" aria-controls="content-path-1" aria-selected="false" tabindex="-1" role="tab" href="javascript:void(0);" aria-live="assertive">
                                        <span class="slds-tabs--path__stage">
                                            <svg class="slds-icon slds-icon--x-small" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Resource.lightning, "/assets/icons/utility-sprite/svg/symbols.svg#check")}"></use>
                                            </svg>
                                        </span>
                                        <span class="slds-tabs--path__title">Payment Information</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </apex:outputPanel>
                <!--Panel for Processbar-->
                <div id="mainContent" style="margin-top:10px;">
                    <div id="searchContent">
                        <div class="{!if(UserisOnSalesforce1, 'slds-form slds-form_stacked','slds-form--compound')}">
                            <div class="slds-form-element__group">
                                <div class="slds-form-element__row">
                                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_1-of-5">
                                        <label class="slds-form-element__label">City</label>
                                        <div class="slds-form-element__control">
                                            <select id="selCity" class="slds-select">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_1-of-5">
                                        <label class="slds-form-element__label" >From Date</label>
                                        <div class="slds-form-element__control">
                                            <div class="slds-input-has-icon slds-input-has-icon--right">
                                                <svg aria-hidden="true" class="slds-input__icon slds-icon-text-default">
                                                    <use xlink:href="{!URLFOR($Resource.lightning, '/assets/icons/utility-sprite/svg/symbols.svg#event')}"></use>
                                                </svg> 
                                                <input type="text" id="dtFromDate" class="slds-input" placeholder="Pick a From Date" label="From Date"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_1-of-5">
                                        <label class="slds-form-element__label" >To Date</label>
                                        <div class="slds-form-element__control">
                                            <div class="slds-input-has-icon slds-input-has-icon--right">
                                                <svg aria-hidden="true" class="slds-input__icon slds-icon-text-default">
                                                    <use xlink:href="{!URLFOR($Resource.lightning, '/assets/icons/utility-sprite/svg/symbols.svg#event')}"></use>
                                                </svg> 
                                                <input type="text" id="dtToDate" class="slds-input" placeholder="Pick a To Date" label="To Date"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_1-of-5">
                                        <label class="slds-form-element__label" >No. of Guests</label>
                                        <div class="slds-form-element__control">
                                            <select id="txtNoofguests" class="slds-select">
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                                <option value="5">5</option>
                                                <option value="6">6</option>
                                                <option value="7">7</option>
                                                <option value="8">8</option>
                                                <option value="9">9</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="slds-form-element slds-size_1-of-1 slds-large-size_1-of-5">
                                        <label class="slds-form-element__label" >&nbsp;</label>
                                        <div class="slds-form-element__control">
                                            <button class="slds-button slds-button--brand btnSearchUnit">SEARCH UNITS</button>
                                            <button class="slds-button slds-button_neutral btnClear">CLEAR</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="divavilableunits" style="margin-top:10px;display:none;">
                            <!--Render this table only when we are on PC-->
                            <apex:outputPanel rendered="{!!UserisOnSalesforce1}">
                                <!-- <table width="100%" class="tblavailableunits slds-table slds-table--bordered slds-table--cell-buffer slds-table--col-bordered" style="border-spacing:0px !important;">
                                    <thead>
                                        <tr>
                                            <th width="10%"><b>Building</b></th>
                                            <th width="20%"><b>Unit</b></th>
                                            <th width="10%"><b>UnitType</b></th>
                                            <th width="10%"><b>Neighborhood</b></th>
                                            <th width="10%"><b>Average Price</b></th>
                                            <th width="10%"><b>Extra Guest Price</b></th>
                                            <th width="10%"><b>Cleaning Fee</b></th>
                                            <th width="10%"><b>Total Tax</b></th>
                                            <th width="10%"><b>Total Price</b></th>
                                            <th width="10%"><b>Action</b></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table> -->
                                <!-- <center>
                                    <div class="slds-form-element" style="margin-top:10px;">
                                        <button class="slds-button slds-button--brand btnNextToBooking">Proceed to Booking</button>
                                    </div>
                                </center> -->
                                
                                <div class="">
                                    <div class="slds-grid">
                                        <div class="slds-col slds-has-flexi-truncate">
                                            <div class="slds-media slds-no-space slds-grow">
                                                <div class="slds-media__body">
                                                    <h1 class="slds-page-header__title   slds-m-right--small slds-truncate sldsAvailableUnit slds-m-top_small slds-m-bottom_small" title="Available Units">Available Units</h1>
                                                    <div class="slds-border_bottom"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- <div class="slds-border_bottom slds-m-top_medium slds-m-bottom_medium slds-text-heading_medium clsPrimayColor">Available Units</div> -->
                                <div class="slds-grid slds-wrap divavailableunits">
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12 slds-large-size_3-of-12">
                                        <div class="slds-box">
                                            <p>This is a small box.</p>
                                        </div>
                                    </div>
                                    
                                </div>

                            </apex:outputPanel>
                            <!--Render this when we are on SF1-->
                            <apex:outputPanel rendered="{!UserisOnSalesforce1}">
                                <!-- <div class="headingFont" style="color:#227E8A;font-size:16pt;margin-bottom:10px;">
                                    Available Units
                                </div> -->
                                
                                <!-- <ul class="slds-accordion clearfix" id="ulavailableunits">
                                  
                                </ul> -->

                                <div class="slds-page-header">
                                    <div class="slds-grid">
                                        <div class="slds-col slds-has-flexi-truncate">
                                            <div class="slds-media slds-no-space slds-grow">
                                                <div class="slds-media__body">
                                                    <h1 class="slds-page-header__title slds-m-right--small slds-truncate" title="Available Units">Available Units</h1>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- <div class="slds-border_bottom slds-m-top_medium slds-m-bottom_medium slds-text-heading_medium headingFont clsPrimayColor">Available Units</div> -->
                                <div class="slds-grid slds-wrap divavailableunits">
                                    <div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12 slds-large-size_3-of-12">
                                        <div class="slds-box">
                                            <p>This is a small box.</p>
                                        </div>
                                    </div>
                                    
                                </div>
                            </apex:outputPanel>
                        </div>
                    </div>
                    <div id="bookingContent" style="display:none;">
                        <div class="slds-grid slds-wrap slds-m-top--large" >
                        <!-- MAIN CARD -->
                        <div class="slds-col slds-size--1-of-1 slds-large-size--1-of-5"></div>
                        <div class="slds-col slds-col-rule--right slds-size--1-of-1 slds-large-size--2-of-5 {!if(UserisOnSalesforce1,'','slds-p-right--large')}">
                            <article class="slds-card">
                                <div class="slds-card__header slds-grid">
                                    <header class="slds-media slds-media--center slds-has-flexi-truncate">
                                        <!--<div class="slds-media__figure">
                                            <span class="slds-icon_container slds-icon-standard-contact" title="description of icon when needed">
                                                <svg class="slds-icon slds-icon--small" aria-hidden="true">
                                                    <use xlink:href="{!URLFOR($Resource.lightning, '/assets/icons/standard-sprite/svg/symbols.svg#account')}"></use>
                                                </svg>
                                            </span>
                                        </div>-->
                                        <div class="slds-media__body">
                                            <h2>
                                                <a href="javascript:void(0);" class="slds-card__header-link" style="font-family:Lato Light;">
                                                    <span class="slds-text-heading--small" id="btunit">Card Header</span>
                                                </a>
                                            </h2>
                                        </div>
                                    </header>
                                </div>
                                <div class="slds-card__body slds-p-left--medium">
                                    <div class="slds-form-element " style="display: inline-flex;">
                                        <label class="slds-form-element__label">Unit Type:</label>
                                        <p id="btunittype" style="padding-left:29px;"></p>
                                    </div>
                                    <br/>
                                    <div class="slds-form-element" style="display: inline-flex;">
                                        <label class="slds-form-element__label">Neighborhood:</label>
                                        <p id="btneighbor" ></p>
                                    </div>
                                </div>
                            </article>
                            <!--
                            <div class="slds-card" id="guestSearchPanel">
                                <header class="slds-card__header slds-grid">
                                    <div class="slds-col slds-media slds-media--center">
                                        <div class="slds-media__figure">
                                            <svg aria-hidden="true" class="slds-icon slds-icon-standard-contact slds-icon--small">
                                                <use xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/standard-sprite/svg/symbols.svg#contact')}"></use>
                                            </svg>
                                        </div>
                                        <div class="slds-media__body">
                                            <h3 class="slds-text-heading--small">Guest Search</h3>
                                        </div>
                                    </div>
                                </header>
                                <!-- CARD BODY = TABLE --
                                <section class="slds-card__body">
                                    <div class="slds-form--compound">
                                        <div class="slds-form-element__group">
                                            <div class="slds-form-element__row">
                                                <div class="slds-form-element slds-size--1-of-2 slds-p-left--medium">
                                                    <label class="slds-form-element__label">Email</label>
                                                    <div class="slds-form-element__control">
                                                        <input type="text" id="txtEmailSearch" class="slds-input" />
                                                    </div>
                                                </div>
                                                <div class="slds-form-element slds-size--1-of-2 slds-p-right--medium">
                                                    <label class="slds-form-element__label">Phone Number</label>
                                                    <div class="slds-form-element__control">
                                                        <input type="text" id="txtPhoneNumberSearch" class="slds-input" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </div>
                            <div class="slds-form--compound">
                                <div class="slds-form-element__group">
                                    <div class="slds-form-element__row">
                                        <div class="slds-size--12-of-12 slds-float--right">
                                            <div class="slds-button-group slds-float_right slds-m-top_x-small" role="group">
                                                <button class="slds-button slds-button_neutral btnSearchGuest">Search</button>
                                                <button class="slds-button slds-button_neutral btnResetGuest">Reset</button>
                                                <button class="slds-button slds-button_neutral btnBackToSearchUnit">Back to Search</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        -->
                            <div class="slds-clearfix">

                                <div id="guestMessagePanel"  style="display:none;">
                                        <div class="slds-notify_container slds-is-relative slds-clearfix">
                                            <div id="guestMessageBrand" class="slds-notify slds-notify_toast slds-size--1-of-1 slds-medium-size--4-of-5" role="alert">
                                                <span class="slds-assistive-text">success</span>
                                                <span class="slds-icon_container slds-icon-utility-success slds-m-right_small slds-no-flex slds-align-top" title="Description of icon when needed">
                                                    <svg class="slds-icon slds-icon_small" aria-hidden="true">
                                                        <use id="guestMessageIcon" xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#success')}" />
                                                    </svg>
                                                </span>
                                                <div class="slds-notify__content" >
                                                    <h2 class="slds-text-heading_small" style="font-size:0.85rem;">Matching Guest found</h2>
                                                </div>
                                                <!--<button class="slds-button slds-button_icon slds-notify__close slds-button_icon-inverse" title="Close">
                                                    <svg class="slds-button__icon slds-button__icon_large" aria-hidden="true">
                                                        <use xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#close')}" />
                                                    </svg>
                                                    <span class="slds-assistive-text">Close</span>
                                                </button>-->
                                            </div>
                                        </div>
                                    </div>

                            </div>
                            
                            
                            <div class="slds-card slds-m-top--small" id="guestPanel">
                                <header class="slds-card__header slds-grid">
                                    <div class="slds-col slds-media slds-media--center">
                                        <!--<div class="slds-media__figure">
                                            <svg aria-hidden="true" class="slds-icon slds-icon-standard-contact slds-icon--small">
                                                <use xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/standard-sprite/svg/symbols.svg#contact')}"></use>
                                            </svg>
                                        </div>-->
                                        <div class="slds-media__body">
                                            <h3 class="slds-text-heading--small" style="font-family:Lato Light;">{!IF(userModel.isStandardUser,'Guest','Billing')} Details</h3>
                                        </div>
                                    </div>
                                </header>
                                <!-- CARD BODY = TABLE -->
                                <section class="slds-card__body">
                                    <div class="slds-form--compound">
                                        <div class="slds-form-element__group">
                                            <div class="slds-form-element__row">
                                                <div class="slds-form-element slds-size--1-of-2  slds-p-left--medium">
                                                    <label class="slds-form-element__label">First Name</label>
                                                    <div class="slds-form-element__control txtFirstName">
                                                        <input type="text" id="txtFirstName" class="slds-input" />
                                                    </div>
                                                </div>
                                                <div class="slds-form-element slds-size--1-of-2 slds-p-right--medium">
                                                    <label class="slds-form-element__label">Last Name</label>
                                                    <div class="slds-form-element__control txtLastName">
                                                        <input type="text" id="txtLastName" class="slds-input" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slds-form-element__row">
                                                <div class="slds-form-element slds-size--1-of-2 slds-p-left--medium">
                                                    <label class="slds-form-element__label">Email</label>
                                                    <div class="slds-form-element__control txtEmail">
                                                        <input type="text" id="txtEmail" class="slds-input" />
                                                    </div>
                                                </div>
                                                <div class="slds-form-element slds-size--1-of-2 slds-p-right--medium">
                                                    <label class="slds-form-element__label">Phone Number</label>
                                                    <div class="slds-form-element__control txtPhoneNumber">
                                                        <input type="text" id="txtPhoneNumber" class="slds-input" />
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <apex:outputPanel rendered="{!userModel.isStandardUser}">
                                                <div class="slds-form-element__row clsShowHideActivity" style="display:none;">
                                                    <div class="slds-form-element slds-size--1-of-2 slds-p-left--medium">
                                                        <label class="slds-form-element__label">Lead Source</label>
                                                        <div class="slds-form-element__control">
                                                             <select id="recenttask" class="slds-select">                                                                                                                                  
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div id="divleadsourcedescription" class="slds-form-element slds-size--1-of-2 slds-p-right--medium" style="display:none">
                                                        <label class="slds-form-element__label">Description</label>
                                                        <div class="slds-form-element__control ">
                                                            <textarea id="leadsourcedescription" class="slds-textarea"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="slds-form-element__row">
                                                    <div class="slds-form-element slds-size--1-of-2 slds-p-left--medium">
                                                        <label class="slds-form-element__label">Sales channel</label>
                                                        <div class="slds-form-element__control">
                                                            <select id="selSalesChannel" class="slds-select">
                                                                <option value="manual">Manual</option>
                                                                <option value="expedia">Expedia</option>
                                                                <option value="airbnb">Airbnb</option>
                                                                <option value="homeaway">Homeaway</option>
                                                                <option value="2nd address">2nd Address</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="blankDiv slds-form-element slds-size--1-of-2 slds-p-right--medium"></div>
                                                    <div style="display:none;" class="externalCodeDiv slds-form-element slds-size--1-of-2 slds-p-right--medium">
                                                        <label class="slds-form-element__label">External Code</label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="externalCode" class="slds-input" maxlength="12" />
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="slds-form-element__row">
                                                    <div class="slds-form-element slds-size--1-of-1 slds-p-left--medium">
                                                        <label class="slds-form-element__label">Purpose of booking</label>
                                                        <div class="slds-form-element__control">
                                                             <textarea id="purposeofbooking" class="slds-textarea"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </apex:outputPanel>
                                        </div>
                                    </div>
                                </section>
                                <!-- / CARD BODY = SECTION + TABLE -->
                                <footer class="slds-card__footer">
                                </footer>
                            </div>
                            
                            <apex:outputPanel styleClass="slds-clearfix" rendered="{!!UserisOnSalesforce1}">
                                <div class="slds-float--right slds-m-top_x-small">
                                    <button class="slds-button slds-button_neutral btnResetGuest">Reset</button>
                                    <button class="slds-button slds-button_neutral btnBackToSearchUnit">
                                        <span class="slds-text-not-selected">
                                            <svg class="slds-button__icon_stateful slds-button__icon_left" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#back')}" />
                                            </svg>
                                            Back to Search
                                        </span>
                                    </button>
                                    <button class="slds-button slds-button--brand btnNextToPayment">Proceed to Payment</button>
                                </div>                           
                            </apex:outputPanel>
                        </div>
                        <!-- compact card -->
                        <div class="slds-col slds-size--1-of-1 slds-large-size--1-of-5 {!if(UserisOnSalesforce1,'','slds-p-left--large')}" style="{!if(UserisOnSalesforce1,'margin-top:10px;margin-bottom:10px;','')}">
                            <fieldset class="slds-form--compound slds-box slds-box--x-small" style="font-size: 14px;">
                                <div class="slds-form-element__group">
                                    <div class="slds-form-element__row">
                                        <div class="slds-form-element slds-size--1-of-2 ">
                                            <label class="slds-form-element__label" for="input-01">Check In</label>
                                            <div class="slds-form-element__control slds-box slds-box--xx-small">
                                                <span id="txtBookingStartDate" class="slds-form-element__static "></span>
                                            </div>
                                        </div>
                                        <div class="slds-form-element slds-size--1-of-2 ">
                                            <label class="slds-form-element__label" for="input-02">Check Out</label>
                                            <div class="slds-form-element__control slds-box slds-box--xx-small">
                                                <span id="txtBookingEndDate" class="slds-form-element__static "></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-form-element__row">
                                        <div class="slds-form-element slds-size--1-of-1 ">
                                            <label class="slds-form-element__label" for="input-03">Guests</label>
                                            <div class="slds-form-element__control slds-box slds-box--xx-small">
                                                <span id="btguest" class="slds-form-element__static slds-p-left--small"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="padding-right: 6px;">
                                        <dl class="slds-list--horizontal slds-wrap slds-m-top--small">
                                            <dt class="slds-item--label slds-text-color--weak slds-truncate" style="font-weight: normal;width: 50%;" >Unit Total</dt>
                                            <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 50%" id="btsubtotal"></dd>
                                        </dl>
                                        <apex:outputPanel rendered="{!userModel.isStandardUser}">
                                            <dl class="slds-list--horizontal slds-wrap slds-p-top--small ">    
                                                <dt class="slds-item--label slds-text-color--weak slds-truncate" style="font-weight: normal;width: 65%;">Discount %</dt>
                                                <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 35%">
                                                    <div class="slds-form--compound slds-form-element__row>">
                                                        <div class="slds-form-element__control " >
                                                            <input type="text" id="discount" class="slds-input" maxlength="6" style="text-align: right;padding-right: 5px;" />
                                                        </div>
                                                    </div>
                                                </dd>
                                            </dl>
                                            <br/>
                                            <dl class="slds-list--horizontal slds-wrap">    
                                                <dt class="slds-item--label slds-text-color--weak slds-truncate" style="font-weight: normal;width: 50%;" >SubTotal</dt>
                                                <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 50%" id="btTotalPriceRef"></dd>
                                            </dl>
                                        </apex:outputPanel>
                                        <hr style="margin: 3px;" />
                                        
                                        <dl class="slds-list--horizontal slds-wrap">
                                            <dt class="slds-item--label slds-text-color--weak slds-truncate" style="font-weight: normal;width: 65%;">Cleaning fee</dt>
                                            <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 35%" id="btcleaningfee"></dd>
                                        </dl>
                                        <hr style="margin: 3px;" />
                                        <dl class="slds-list--horizontal slds-wrap">    
                                            <dt class="slds-item--label slds-text-color--weak slds-truncate" style="font-weight: normal;width: 60%;" >Total Tax</dt>
                                            <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 40%" id="bttax"></dd>
                                        </dl>
                                    </div>
                                    
                                    <!--<hr style="margin: 8px;" />-->
                                    <br/><dl class="slds-list--horizontal slds-wrap" style="font-weight: bold;"> 
                                        <dt class="slds-item--label slds-text-color--weak slds-truncate " style="width: 50%;">Final Price</dt>
                                        <apex:outputPanel rendered="{!userModel.isStandardUser}" layout="none">
                                            <dd class="slds-item--detail slds-truncate slds-text-align--right" style="width: 50%">
                                                <div class="slds-form--compound slds-form-element__row>">
                                                    <div class="slds-form-element__control " >
                                                        <input type="text" id="bttotalprice" class="slds-input" style="text-align: right;padding-right: 5px;" />
                                                    </div>
                                                </div>
                                            </dd>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!!userModel.isStandardUser}" layout="none">
                                            <dd class="slds-item--detail slds-truncate slds-text-align--right" id="bttotalpriceText" style="width: 50%" />
                                        </apex:outputPanel>
                                    </dl>
                                </div>
                            </fieldset>
                        </div>
                        <div class="slds-col slds-size--1-of-1 slds-large-size--1-of-5">
                            <apex:outputPanel styleClass="slds-clearfix" rendered="{!UserisOnSalesforce1}">
                                <div class="slds-m-top_x-small">
                                    <button class="slds-button slds-button_neutral btnResetGuest">Reset</button>
                                    <button class="slds-button slds-button_neutral btnBackToSearchUnit">
                                        <span class="slds-text-not-selected">
                                            <svg class="slds-button__icon_stateful slds-button__icon_left" aria-hidden="true">
                                                <use xlink:href="{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#back')}" />
                                            </svg>
                                            Back to Search
                                        </span>
                                    </button>
                                    <button class="slds-button slds-button--brand btnNextToPayment">
                                        Proceed to Payment
                                    </button>
                                </div>                           
                            </apex:outputPanel>
                        </div>
                    <!-- compact card end -->
                    </div >
                        
                    </div>
                    <div id="paymentContent" style="display:none;margin-bottom:25px;">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size--1-of-1 slds-large-size--1-of-3"></div>
                            <div class="slds-form--compound slds-col slds-size--1-of-1 slds-large-size--1-of-3">
                                <div class="priceCard">
                                    <article class="slds-card slds-card--narrow">
                                        <div class="slds-card__header slds-grid">
                                            <header class="slds-media slds-media--center slds-has-flexi-truncate">
                                                <!--<div class="slds-media__figure">
                                                    <span class="slds-icon_container slds-icon-standard-account" title="Booked Unit">
                                                        <svg class="slds-icon slds-icon--small" aria-hidden="true">
                                                            <use xlink:href="{!URLFOR($Resource.lightning, "/assets/icons/standard-sprite/svg/symbols.svg#account")}"></use>
                                                        </svg>
                                                    </span>
                                                </div>-->
                                                <div class="slds-media__body">
                                                    <h2 id="pcunit" class="slds-text-heading--small">
                                                        <a href="javascript:void(0);" class="slds-card__header-link slds-truncate" style="font-family:Lato Light;">
                                                            <span class="slds-text-heading--small"></span>
                                                        </a>
                                                    </h2>
                                                </div>
                                            </header>
                                        </div>
                                        <div class="slds-card__body" style="padding-left:1rem;">
                                            <!-- <p id="pcsubtotal">SubTotal</p>
                                            <p id="pccleaningfee">Cleaning fee</p>
                                            <p id="pctax"></p>
                                            <p id="pcdis"></p>
                                            <p id="pctotalprice"></p> -->
                                            <div class="slds-tile__detail slds-media__body slds-p-right--large">
                                                <dl class="slds-list--horizontal slds-wrap">
                                                    <dt class="slds-item--label slds-text-color--weak " style="font-weight: normal;" >Unit Total:</dt>
                                                    <dd class="slds-item--detail  slds-text-align--right" id="pcsubtotal"></dd>
                                                    <apex:outputPanel rendered="{!userModel.isStandardUser}" layout="none">
                                                        <dt class="slds-item--label slds-text-color--weak " style="font-weight: normal;">Discount %:</dt>
                                                        <dd class="slds-item--detail  slds-text-align--right" id="pcdis"></dd>
                                                        <dt class="slds-item--label slds-text-color--weak  " style="font-weight: normal;">SubTotal:</dt>
                                                        <dd class="slds-item--detail  slds-text-align--right " id="pcTotalPriceRef"></dd>
                                                    </apex:outputPanel>
                                                    <dt class="slds-item--label slds-text-color--weak " style="font-weight: normal;">Cleaning fee:</dt>
                                                    <dd class="slds-item--detail  slds-text-align--right" id="pccleaningfee"></dd>
                                                    <dt class="slds-item--label slds-text-color--weak " style="font-weight: normal;" >Total Tax:</dt>
                                                    <dd class="slds-item--detail  slds-text-align--right" id="pctax"></dd>
                                                    
                                                    <dt class="slds-item--label slds-text-color--weak  " style="font-weight: normal;">Final Price:</dt>
                                                    <dd class="slds-item--detail  slds-text-align--right " id="pctotalprice"></dd>
                                                </dl>
                                            </div>
                                        </div>
                                        <div class="slds-card__footer"></div>
                                    </article>
                                </div>
                                
                                <div class="slds-form-element__group slds-box slds-box--x-small slds-m-top--small">
                                    <apex:outputPanel rendered="{!userModel.isStandardUser}" layout="none">
                                        <div class="slds-form-element__group slds-box--x-small">                                            
                                                    
                                            <div id="bkmorethen30" class="slds-form-element__row slds-radio_button-group" style="border:0px;">
                                                <div class="slds-form-element slds-size--1-of-1">
                                                    <label class="slds-form-element__label">
                                                        How will this monthly booking be charged?
                                                    </label>
                                                    <div class="slds-form-element__control slds-radio_button-group" style="border:0px;">
                                                        <span class="slds-radio">
                                                            <input type="radio" id="rdmtm" value="rdmtm" name="default" checked="checked" />
                                                            <label class="slds-radio__label" for="rdmtm">
                                                              <span class="slds-radio_faux"></span>
                                                              <span class="slds-form-element__label">Month-to-Month</span>
                                                            </label>
                                                        </span>
                                                        <span class="slds-radio">
                                                            <input type="radio" id="rdcaup" value="rdcaup" name="default" />
                                                            <label class="slds-radio__label" for="rdcaup">
                                                                <span class="slds-radio_faux"></span>
                                                                <span class="slds-form-element__label">Charge all upfront</span>
                                                            </label>
                                                        </span>

                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="slds-form-element__row">
                                                <div class="slds-form-element slds-size--1-of-1">
                                                    <span class="slds-checkbox" >
                                                        <input type="checkbox" id="disableCleaning" value="" />
                                                        <label for="disableCleaning" class="slds-checkbox__label" >
                                                            <span class="slds-checkbox_faux"></span>
                                                            <span class="slds-form-element__label" >
                                                                Disable auto-cleaning upon checkout e.g. for maintenance
                                                            </span>
                                                        </label>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="slds-form-element__row">
                                                <div class="slds-form-element slds-size--1-of-1">
                                                    <label class="slds-form-element__label">
                                                        Private Comment
                                                    </label>
                                                    <div class="slds-form-element__control">
                                                        <textarea id="privateComment" class="slds-textarea"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </apex:outputPanel>
                                    <div id="ccPanel">
                                        <div class="slds-form-element__group slds-box--x-small" id="cardsPanel">
                                        </div>
                                        <div class="slds-form-element__group slds-box--x-small">
                                            <div class="slds-form-element">
                                                <div class="slds-form-element__control" >
                                                    <span class="slds-checkbox" >
                                                        <input type="checkbox" id="updateCardDetails" value="" onchange="showHideCardPanel();" />
                                                        <label for="updateCardDetails" class="slds-checkbox__label" >
                                                            <span class="slds-checkbox_faux"></span>
                                                            <span class="slds-form-element__label" >
                                                                Add/Update Credit Card
                                                            </span>
                                                        </label>
                                                    </span>
                                                </div>
                                            </div>
                                            <div id="ccDetailPanel">
                                                <div class="slds-form-element__row">
                                                    <div class="slds-form-element slds-size--1-of-1 ">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Card Number
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="txtCardNumber" maxlength="16" minlength="12" pattern="[0-9]*" required="true" class="slds-input" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="slds-form-element__row">
                                                    <div class="slds-form-element slds-size--1-of-2">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Exp. Month
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <select id="txtExpMonth" class="slds-select">
                                                                <option value="">Select</option>
                                                                <option value="01">01-January</option>
                                                                <option value="02">02-February</option>
                                                                <option value="03">03-March</option>
                                                                <option value="04">04-April</option>
                                                                <option value="05">05-May</option>
                                                                <option value="06">06-June</option>
                                                                <option value="07">07-July</option>
                                                                <option value="08">08-August</option>
                                                                <option value="09">09-September</option>
                                                                <option value="10">10-October</option>
                                                                <option value="11">11-November</option>
                                                                <option value="12">12-December</option>
                                                            </select>
                                                            <!--<input type="text" id="txtExpMonth" class="slds-input" />-->
                                                        </div>
                                                    </div>
                                                    <div class="slds-form-element slds-size--1-of-2">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Exp. Year
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <select id="txtExpYear" class="slds-select">
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="slds-form-element__row">
                                                    <div class="slds-form-element slds-size--1-of-1 ">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Name on Card
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="txtNameonCard" class="slds-input" />
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="slds-form-element__row">
                                                    <!--<div class="slds-form-element slds-size--1-of-2">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Card Type
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="txtCardType" class="slds-input" />
                                                        </div>
                                                    </div>-->
                                                    <div class="slds-form-element slds-size--1-of-2">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            CVV
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="txtCVV" class="slds-input" maxlength="4" minlength="3" pattern="[0-9]*" />
                                                        </div>
                                                    </div>
                                                    <div class="slds-form-element slds-size--1-of-2">
                                                        <label class="slds-form-element__label">
                                                            <abbr title="required" class="slds-required">*</abbr>
                                                            Zip Code
                                                        </label>
                                                        <div class="slds-form-element__control">
                                                            <input type="text" id="txtZipCode" class="slds-input" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <center>
                                    <div class="slds-form-element " style="margin-top:10px;margin-bottom:50px;">
                                        <button class="slds-button slds-button_neutral btnBackToBooking">Back to Booking</button>
                                        <button class="slds-button slds-button--brand btnBookUnit"><span class="clsbookunit">Book Unit</span></button>
                                    </div>
                                </center>
                            </div>
                            <div class="slds-col slds-size--1-of-1 slds-large-size--1-of-3"></div>
                        </div>
                        <!-- <center>
                            <div class="slds-form-element slds-size--1-of-3 slds-small-size--1-of-3 slds-medium-size--1-of-3" style="margin-top:10px;">
                                <button class="slds-button slds-button--brand btnBackToBooking">Back to Booking</button>
                                <button class="slds-button slds-button--brand btnBookUnit">Book Unit</button>
                            </div>
                        </center> -->
                    </div>
                </div>
            </div>
            </apex:outputPanel>

            <script src="{!URLFOR($Resource.jquery3)}"></script>
            <script src="{!URLFOR($Resource.fancybox,'/fancybox/jquery.fancybox.min.js')}"></script>

            <script src="{!URLFOR($Resource.starrating,'scripts/jquery.rateit.min.js')}"></script>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.js"></script>
            <script src="{!URLFOR($Resource.aljs, '/jquery.aljs-init.min.js')}"></script>
            <script src="{!URLFOR($Resource.aljs, '/jquery.aljs-datepicker.min.js')}"></script>

            <!--
            <script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
            <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>-->
            
            <script type="text/javascript" src="{!URLFOR($Resource.slickslider, 'slick/slick.min.js')}"></script>
        </body>
    </html>
    <script>
        //Assigning SLDS Static Resource Path To A Variable To Use It With ALJS Initialization
        var assetsLoc = '{!URLFOR($Resource.lightning)}';
        var objBooking = new Object();
        //var totPrice;
        var bookingId;
        var savedCards;
        var selectedCardId='';
        var defaultSourceId='';
        var unitName = ''
        var unitTax;
        var unitPrice;
        var unitCleanfee;
        <!--Model message box-->
        
        function getSuccessMessagebox(){
            return '<div id="divMessagebox">\
              <div aria-hidden="false" role="dialog" class="slds-modal slds-fade-in-open"> \
                <div class="slds-modal__container"> \
                  <div class="slds-modal__header"> \
                    <h2 class="slds-text-heading--medium">{title}</h2> \
                  </div> \
                  <div class="slds-modal__content slds-p-around--medium"> \
                    <div> \
                      <p>{message}</p> \
                    </div> \
                  </div> \
                </div> \
              </div> \
              <div class="slds-backdrop slds-backdrop--open"></div> \
            </div>';
        }
        function getMessagebox(){
            return '<div id="divMessagebox">\
              <div aria-hidden="false" role="dialog" class="slds-modal slds-fade-in-open"> \
                <div class="slds-modal__container"> \
                  <div class="slds-modal__header"> \
                    <h2 class="slds-text-heading--medium">{title}</h2> \
                    <button class="slds-button slds-button--icon-inverse slds-modal__close btnCloseMessagebox"> \
                       <svg class="slds-button__icon slds-button__icon--large" aria-hidden="true"> \
                         <use xlink:href="{!URLFOR($Resource.lightning, '/assets/icons/utility-sprite/svg/symbols.svg#close')}"></use> \
                       </svg> \
                      <span class="slds-assistive-text">Close</span> \
                    </button> \
                  </div> \
                  <div class="slds-modal__content slds-p-around--medium"> \
                    <div> \
                      <p>{message}</p> \
                    </div> \
                  </div> \
                  <div class="slds-modal__footer"> \
                    <div class="slds-x-small-buttons--horizontal"> \
                      {cancelbutton} \
                      {actionbutton} \
                    </div> \
                  </div> \
                </div> \
              </div> \
              <div class="slds-backdrop slds-backdrop--open"></div> \
            </div>';
        }
        
        <!--Close Message box--->
        $(document).on('click','.btnCloseMessagebox',function(){
            $('.slds').find('#divMessagebox').remove();
            return false;
        });
                          
        $(document).on('click','.btnOkayMessagebox',function(){
            $('.slds').find('#divMessagebox').remove();
            return false;
        });

        $(document).on('click','.btnCancelToRedirectMessagebox',function(){
            
                          window.location.reload();
            return false;
        });
        
        $(document).on('click','.btnCloseBookingMessagebox',function(){
            // $('.slds').find('#divMessagebox').remove();
            // $('a#search').closest('li').removeClass('slds-is-complete').addClass('slds-is-current');
            // $('a#booking').closest('li').removeClass('slds-is-complete').addClass('slds-is-incomplete');
            // $('a#payment').closest('li').removeClass('slds-is-current').addClass('slds-is-incomplete');
            // $('div#searchContent').show();
            // $('div#bookingContent').hide();
            // $('div#paymentContent').hide();
            window.top.location.href = '/'+bookingId;
            // return false;
        });
        
        //ALJS Initialization   
        $.aljsInit({
            assetsLocation: assetsLoc
        });
        
        $(document).ready(function() {
            init();
        });
        
        function init(){
            if({!userModel.isStandardUser} || {!userModel.isBookingAllowed}){
                objBooking = new Object();
                //Initializing Datepicker with options To The SLDS Input on document ready.
                $('#dtFromDate,#dtToDate,#txtBookingStartDate,#txtBookingEndDate').datepicker({
                    format: 'MM/DD/YYYY',
                    numYearsBefore: 2,
                    onChange: function() {
                        $('#divavilableunits').hide();
                    }
                });
                fnBindCities();
                fnBindYear();
                bindFiltersOnChange();
                prefilGuestDetailsForCommunityUser();
            }
        }
        function prefilGuestDetailsForCommunityUser(){
            if({!!userModel.isStandardUser} && {!userModel.isBookingAllowed}){
                $('#cardsPanel').html('');
                
                var conModel = JSON.parse('{!userModel.conModel}');
                
                if(conModel != undefined && conModel != null){
                    var con = conModel.contact;
                    savedCards = conModel.ccModelList;
                    
                    if(con.FirstName && con.FirstName.trim().length>0){
                        var fn = $('#txtFirstName');
                        $(fn).parent().append(con.FirstName);
                        $(fn).remove();
                    }
                    
                    // $('#txtLastName').val(con.LastName);
                    var ln = $('#txtLastName');
                    $(ln).parent().append(con.LastName);
                    $(ln).remove();
                    if(con.Email && con.Email.trim().length>0){
                        // $('#txtEmail').val(con.Email);
                        var em = $('#txtEmail');
                        $(em).parent().append(con.Email);
                        $(em).remove();
                    }
                    if(con.Phone && con.Phone.trim().length>0){
                        // $('#txtPhoneNumber').val(con.Phone); 
                        var ph = $('#txtPhoneNumber');
                        $(ph).parent().append(con.Phone);
                        $(ph).remove();
                    }
                    objBooking.Firstname__c = con.FirstName;
                    objBooking.Lastname__c = con.LastName;
                    objBooking.Email__c = con.Email;
                    objBooking.Phone_number__c = con.Phone;
                    objBooking.Billing_Contact__c = con.Id;
                }else{ 
                    objBooking.Billing_Contact__c = null;  
                    savedCards = null;
                } 
            }
        }
        function fnBindCities(){
            $('select[id$=selCity]').empty();
            $('select[id$=selCity]').append('<option value="">Select</option>');
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.UnitBookingController.allCities}',
                function (result, event) {
                    if (event.status) {
                        if(result != undefined){
                            var option = '<option value="{name}">{name}</option>';
                            $.map(result,function(str,i){
                                var newoption = option;
                                newoption = newoption.replace('{name}',str.Name).replace('{name}',str.Name);
                                $('select[id$=selCity]').append(newoption);
                            });
                        }
                    } else if (event.type === 'exception') {
                        alert(event.message + ' ' + event.where);
                    } else {
                        alert(event.message);
                    }
                },
                { buffer: true, escape: true, timeout: 120000 }
            );
        }
        
        function fnBindYear(){
            $('select[id$=txtExpYear]').empty();
            $('select[id$=txtExpYear]').append('<option value="">Select</option>');
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.UnitBookingController.allYear}',
                function (result, event) {
                    if (event.status) {
                        if(result != undefined){
                            var option = '<option value="{name}">{name}</option>';
                            $.map(result,function(str,i){
                                var newoption = option;
                                newoption = newoption.replace('{name}',str).replace('{name}',str);
                                $('select[id$=txtExpYear]').append(newoption);
                            });
                        }
                    } else if (event.type === 'exception') {
                        alert(event.message + ' ' + event.where);
                    } else {
                        alert(event.message);
                    }
                },
                { buffer: true, escape: true, timeout: 120000 }
            );
        }
        
        $(document).on('click','.btnBackToBooking',function(){
            $('div#bookingContent').show();
            $('div#paymentContent').hide();
        });

        $(document).on('click','.btnBackToSearchUnit',function(){
            // let imgpath = gb_imgurl;
            // let img = new Image();
            // img.src = imgpath;

            //$( window ).resize();

            // debugger;
            

            $('div#searchContent').show();
            $('div#bookingContent').hide();
            if({!userModel.isStandardUser})
                $('#discount').val('');

            setTimeout(function(){

                var currindexslide = gbimgobject.slick('slickCurrentSlide');

                gbimgobject.slick('destroy');
                
                gbimgobject.slick({
                    slidesToShow   : 1,
                    infinite : false,
                    dots     : true,
                    arrows   : false,
                    speed    : 300
                });
                
                gbimgobject.slick('slickGoTo',currindexslide,true);

                
            }, 100);
        });
        
        if({!userModel.isStandardUser} && {!userModel.isBookingAllowed}){
            $(document).on('change','#bttotalprice',function(){
                calculateAmountsWhenFinalPriceChanges();
            });
            
            $(document).on('change','#discount',function(evt){
                // console.log(evt.keyCode);
                var discount = $(this).val();
                calculateAmountsWhenDiscountPercentChanges();
            });
            $(document).on('keyup','#discount',function(evt){
                // console.log(evt.keyCode);
                var charCode = evt.keyCode;
                //var discount = $('#discount').val();
                if ((charCode > 95 && charCode < 106 ) || (charCode < 58 && charCode > 47) || charCode == 8 || charCode == 46 || charCode == 110 || charCode == 190 || (charCode <= 40 && charCode >= 37)){
                    
                    calculateAmountsWhenDiscountPercentChanges();
                } else {
                    return false;
                }
            });
            
            $(document).on('keyup','#bttotalprice',function(evt){
                // console.log(evt.keyCode);
                var charCode = evt.keyCode;
                //var bttotalprice = $('#bttotalprice').val();
                if ((charCode > 95 && charCode < 106 ) || (charCode < 58 && charCode > 47) || charCode == 8 || charCode == 46 || charCode == 110 || charCode == 190 || (charCode <= 40 && charCode >= 37)){
                    
                    calculateAmountsWhenFinalPriceChanges();
                } else {
                    //$('#discount').val('');
                    //$('#bttotalprice').val(totPrice);
                    return false;
                }
            });
            function calculateAmountsWhenDiscountPercentChanges(){
                var discount = $('#discount').val();
                if(discount != undefined && discount != '' && discount > 0){
                    discount = parseFloat(discount).toFixed(2);
                    var discountedPrice = (unitPrice - ((parseFloat(unitPrice)*discount)/100)).toFixed(2);
                    var updatedTax = ((parseFloat(discountedPrice) + parseFloat(unitCleanfee))*unitTax).toFixed(2);
                    var updatedTotalPrice = (parseFloat(discountedPrice) + parseFloat(unitCleanfee) + parseFloat(updatedTax)).toFixed(2);
                    $('#pctax').html("$" + updatedTax);
                    $('#bttax').html("$" + updatedTax);
                    $('#bttotalprice').val(updatedTotalPrice);
                    $('#pctotalprice').html("$" + updatedTotalPrice);
                    $('#pcdis').html(discount + "%");
                    $('#btTotalPriceRef').html("$" + discountedPrice);
                    $('#pcTotalPriceRef').html("$" + discountedPrice);
                } else {
                    var updatedTax = (( parseFloat(unitPrice) + parseFloat(unitCleanfee) )*parseFloat(unitTax)).toFixed(2);
                    var updatedTotalPrice = (parseFloat(unitPrice) + parseFloat(unitCleanfee) + parseFloat(updatedTax)).toFixed(2);
                    $('#bttotalprice').val(updatedTotalPrice);
                    $('#pctotalprice').html("$" + updatedTotalPrice);
                    $('#btTotalPriceRef').html("$" + unitPrice);
                    $('#pcTotalPriceRef').html("$" + unitPrice);
                    $('#pctax').html("$" + updatedTax);
                    $('#bttax').html("$" + updatedTax);
                    $('#pcdis').html("0.00%");
                }
            }
            function calculateAmountsWhenFinalPriceChanges(){
                
                var bttotalprice = $('#bttotalprice').val();
                if(!bttotalprice || isNaN(bttotalprice))
                    bttotalprice = 0;
                bttotalprice = parseFloat(bttotalprice).toFixed(2);
                console.log('@@@bttotalprice=='+bttotalprice);
                console.log('@@@unitPrice=='+unitPrice);
                console.log('@@@unitCleanfee=='+unitCleanfee);
                console.log('@@@unitTax=='+unitTax);
                
                $('#pctotalprice').html("$" + bttotalprice);
                //Calculating discount amount from final price
                var discountAmount = 
                        (
                            (
                                parseFloat(unitPrice) + parseFloat(unitCleanfee) - parseFloat(bttotalprice) + 
                                (
                                    (( parseFloat(unitPrice) + parseFloat(unitCleanfee)) *parseFloat(unitTax))
                                )
                            )/(1+parseFloat(unitTax))
                        ).toFixed(2);
                console.log('@@@discountAmount=='+discountAmount);
                var discountedPrice = (unitPrice - discountAmount).toFixed(2);
                var discountPercentage =  ((discountAmount*100)/unitPrice).toFixed(2)
                console.log('@@@discountedPrice=='+discountedPrice);
                console.log('@@@discountPercentage=='+discountPercentage);
                $('#btTotalPriceRef').html("$" + discountedPrice);
                $('#pcTotalPriceRef').html("$" + discountedPrice);
                $('#discount').val(discountPercentage);
                $('#pcdis').html(discountPercentage+ "%");
                //Recalculating TaxAmount
                var updatedTax = ((parseFloat(discountedPrice) + parseFloat(unitCleanfee))*parseFloat(unitTax)).toFixed(2);
                gb_cleaningfee = parseFloat(unitCleanfee);
                $('#pctax').html("$" + updatedTax);
                $('#bttax').html("$" + updatedTax);
            }
        }
            
        function fnmadepaymentRequestofbooking(objrm, defaultsourceid){
             $('#divProcessing').show();
             
             let ismonthtomonth = $('#rdcaup').is(':checked');
             if(ismonthtomonth == undefined || ismonthtomonth == null) {
                 ismonthtomonth = false;
             }
             
             Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.UnitBookingController.chargePayment}', objrm, defaultsourceid, ismonthtomonth,
                    function (result, event) {

                        $('#divProcessing').hide();
                        if(!result.isError){
                            var d = getSuccessMessagebox();
                            d = d.replace('{title}','Confirmation');
                            d = d.replace('{message}','Booking is Succesfully Done.');
                            var btnclose = '<button class="slds-button slds-button_neutral btnCloseBookingMessagebox">Close</button>';
                            d = d.replace('{cancelbutton}',btnclose);
                            d = d.replace('{actionbutton}','');
                            $('.slds').find('#divMessagebox').remove();
                            $('.slds').append(d);
                            window.setTimeout(function() {
                                if(typeof sforce != 'undefined' && sforce != null) {
                                    sforce.one.navigateToSObject(result.recordId);
                                } else {
                                    window.top.location.href = '/'+result.recordId;
                                }
                            }, 300);
                        }else if(result.isError){
                            let exceptionmsg = '';
                            if(result.errMsgs.length > 0 && result.errMsgs[0] != null){
                                exceptionmsg = result.errMsgs[0];
                            }
                             var d = getMessagebox();
                            d = d.replace('{title}','Error Message');
                            d = d.replace('{message}','Payment processing failed with the following error: ' + exceptionmsg + ' <div>Please click the \'OK\' button to retry payment!</div>');
                            var btnclose = '<button class="slds-button slds-button_neutral btnCancelToRedirectMessagebox">Cancel</button>';
                             var btnOkay = '<button class="slds-button slds-button_neutral btnOkayMessagebox">Ok</button>';
                            d = d.replace('{cancelbutton}',btnclose);
                            d = d.replace('{actionbutton}',btnOkay);
                            $('.slds').find('#divMessagebox').remove();
                            $('.slds').append(d);
                               
                        }else if (event.type === 'exception') {
                                // alert(event.message + ' :: ' + event.where);
                                var d = getMessagebox();
                                d = d.replace('{title}','Error Message');
                                d = d.replace('{message}',event.message + ' :: ' + event.where);
                                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                                d = d.replace('{cancelbutton}',btnclose);
                                d = d.replace('{actionbutton}','');
                                $('.slds').find('#divMessagebox').remove();
                                $('.slds').append(d);
                                $(this).blur();
                                return false;
                        } else {
                            alert(event.message);
                        }
                    },
                    { buffer: true, escape: true, timeout: 120000 }
                );
        };
            
        
        $(document).on('click','.btnBookUnit',function(){
            
            $(this).blur();
            let strtaskid = '';//$('#recenttask').val(); // need to check required for task
            var cardnumber = $('#txtCardNumber').val();
            var nameoncard = $('#txtNameonCard').val();
            var expmonth = $('#txtExpMonth').val();
            var expyear = $('#txtExpYear').val();
            var cardcvv = $('#txtCVV').val();
            var cardtype = $('#txtCardType').val();
            var zipcode = $('#txtZipCode').val();
            var discount;
            var disableCleaning;
            var privateComment;
            let purposeofbooking= $("#purposeofbooking").val();
            let leadsourcedescription = $("#leadsourcedescription").val();
            if({!userModel.isStandardUser}){
                discount = $('#pcdis').html();
                discount = discount.replace('%','');
                disableCleaning = $("#disableCleaning").is(':checked');
                privateComment = $("#privateComment").val();
            }
            var subtotal = $('#pcsubtotal').html();
            subtotal = subtotal.replace('$','');
            var totalprice = $('#pctotalprice').html();
            var bookingStartDate = $('#txtBookingStartDate').html();
            bookingStartDate = bookingStartDate.toString();
            var bookingEndDate = $('#txtBookingEndDate').html();
            bookingEndDate = bookingEndDate.toString();
            totalprice = parseFloat(totalprice.replace('$',''));
            if((objBooking.Sales_channel__c == 'airbnb' && (purposeofbooking != "" && purposeofbooking != undefined))
                ||(
                    (purposeofbooking != "" && purposeofbooking != undefined) &&
                        (
                            ((!discount || discount<100) && (totalprice && totalprice>0))
                            || privateComment 
                        ) 
                    &&(
                        (!totalprice || totalprice<=0)
                        || (selectedCardId != undefined && selectedCardId.trim().length>0 && selectedCardId != 'newCard') 
                        ||  (
                            $("#updateCardDetails").is(':checked') &&
                            isValidCardNumber(cardnumber) && !isBlank(nameoncard) && 
                            !isBlank(expmonth)&& !isBlank(expyear) && isValidExpiration(expmonth, expyear) &&
                            isValidCVV(cardcvv) && !isBlank(zipcode)
                            // && !isBlank(cardtype)
                        )
                    )
                )
            ){
                                               
                $('#divProcessing').show();
                
                if(objBooking.Sales_channel__c == 'airbnb' || (!totalprice || totalprice<=0) || 
                    (selectedCardId != undefined && selectedCardId.trim().length>0 && selectedCardId != 'newCard')
                ){
                    objBooking.Credit_Card_Number__c = null;
                    objBooking.Credit_Card_Full_Name__c = null; 
                    objBooking.Credit_Card_CVV__c = null;
                    objBooking.Credit_Card_Type__c = null;
                    objBooking.Zip_Code__c = null;
                    objBooking.Credit_Card_Expiration_Date__c = null;
                }else{
                    objBooking.Credit_Card_Number__c = cardnumber;
                    objBooking.Credit_Card_Full_Name__c = nameoncard; 
                    objBooking.Credit_Card_CVV__c = cardcvv;
                    objBooking.Credit_Card_Type__c = cardtype;
                    objBooking.Zip_Code__c = zipcode;
                    objBooking.Credit_Card_Expiration_Date__c = expmonth + '/'+expyear;
                }
                
                objBooking.Disable_Cleanings__c = disableCleaning;
                objBooking.Private_comment__c = privateComment;
                objBooking.Purpose_of_booking__c = purposeofbooking;
                
                if(leadsourcedescription != undefined && leadsourcedescription != null && leadsourcedescription != ''){
                  objBooking.Lead_Source_Other_Description__c = leadsourcedescription;
                }
                
                if({!userModel.isStandardUser})
                    objBooking.Discount__c = discount;
                // if(discount != null && discount != null && parseFloat(discount) > 0) {
                //     objBooking.Booking_comment__c = objBooking.Booking_comment__c + '\n Discount: '+discount+'% ('+(parseFloat(totPrice)-parseFloat(totalprice)).toFixed(2)+')';
                // }
                objBooking.Sub_Total__c = subtotal;
                objBooking.Total_taxed__c = parseFloat(totalprice);
                
                // console.log('Booking ::: '+objBooking);
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.UnitBookingController.BookUnitWrapper}',objBooking , bookingStartDate, bookingEndDate, unitName, selectedCardId, defaultSourceId, true, strtaskid,
                    function (result, event) {
                        
                        $('#divProcessing').hide();
                        console.log(result);
                        if (event.status) {
                            if(result.isError){
                                if(
                                    result.contactId != undefined && result.contactId != null &&
                                    (objBooking.Billing_Contact__c == undefined || objBooking.Billing_Contact__c == null)
                                ){
                                    objBooking.Billing_Contact__c = result.contactId;
                                    
                                    applyGuestFoundMessage();
                                        
                                }
                                var errmsg = '';
                                for(var i=0; i<result.errMsgs.length; i++){
                                    errmsg += '<li>'+result.errMsgs[i]+'</li>';
                                }
                                var d = getMessagebox();
                                d = d.replace('{title}','Error Message');
                                d = d.replace('{message}',errmsg);
                                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                                d = d.replace('{cancelbutton}',btnclose);
                                d = d.replace('{actionbutton}','');
                                $('.slds').find('#divMessagebox').remove();
                                $('.slds').append(d);
                                $(this).blur();
                                return false;
                            }else{
                                //merge2Account(); // to merge acc records
                                /*var d = getSuccessMessagebox();
                                d = d.replace('{title}','Confirmation');
                                d = d.replace('{message}','Booking is Succesfully Done.');
                                var btnclose = '<button class="slds-button slds-button_neutral btnCloseBookingMessagebox">Close</button>';
                                d = d.replace('{cancelbutton}',btnclose);
                                d = d.replace('{actionbutton}','');
                                $('.slds').find('#divMessagebox').remove();
                                $('.slds').append(d);
                                window.setTimeout(function() {
                                    if(typeof sforce != 'undefined' && sforce != null) {
                                        sforce.one.navigateToSObject(result.recordId);
                                    } else {
                                        window.top.location.href = '/'+result.recordId;
                                    }
                                }, 100);*/
                                
                                fnmadepaymentRequestofbooking(result, defaultSourceId)
                            }
                        } else if (event.type === 'exception') {
                            // alert(event.message + ' :: ' + event.where);
                            var d = getMessagebox();
                            d = d.replace('{title}','Error Message');
                            d = d.replace('{message}',event.message + ' :: ' + event.where);
                            var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                            d = d.replace('{cancelbutton}',btnclose);
                            d = d.replace('{actionbutton}','');
                            $('.slds').find('#divMessagebox').remove();
                            $('.slds').append(d);
                            $(this).blur();
                            return false;
                        } else {
                            alert(event.message);
                        }
                    },
                    { buffer: true, escape: true, timeout: 120000 }
                );
            } else {
                var errmsg = '';
                
                if(
                    (
                        (discount && discount>=100) 
                        || (!totalprice || totalprice<=0)
                    ) 
                    && !privateComment)
                {
                    errmsg = '<li>"Private Comment" is required for 100% or more discount or Final Price of $0 bookings</li>';
                }else if(!purposeofbooking){
                    errmsg = '<li>"Purpose of Booking" is required</li>';
                }else if($("#updateCardDetails").is(':checked')){
                    if(!isValidCardNumber(cardnumber))
                        errmsg += '<li>Enter valid Credit Card Number</li>';
                    if(isBlank(expmonth) || isBlank(expyear))
                        errmsg += '<li>Enter valid Expiration Date</li>';  
                    else if(!isValidExpiration(expmonth, expyear)){
                        errmsg += '<li>Expiration Date must be in future</li>';   
                    }
                    if(isBlank(nameoncard))
                        errmsg += '<li>Enter valid Card Name</li>';   
                    if(!isValidCVV(cardcvv))
                        errmsg += '<li>Enter valid CVV</li>';     
                    if(isBlank(zipcode))
                        errmsg += '<li>Enter valid Zip Code</li>';     
                }else if(savedCards != undefined && savedCards != null && savedCards.length>0 && 
                    (selectedCardId==undefined || selectedCardId.trim().length==0)
                ){
                    errmsg = '<li>Please select either an existing card or add details to pay with new card</li>';
                }
                
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                d = d.replace('{message}',errmsg);
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }
        });
        
        function isValidCardNumber(cardnumber){
            return (cardnumber != undefined && !isNaN(cardnumber) && cardnumber.trim().length >= 12 && cardnumber.trim().length <= 16);
        }
        function isValidExpiration(expmonth, expyear){
            var todayDate = new Date();
            var expDate = new Date(expyear,expmonth,0);
            if(expDate<todayDate)
                return false;
            return true;   
        }
        function isBlank(tempVar){
            return (tempVar == undefined || tempVar.trim().length == 0);
        }
        function isValidCVV(cardcvv){
            return (cardcvv != undefined && !isNaN(cardcvv) && cardcvv.trim().length >= 3 && cardcvv.trim().length <= 4);
        }
        function bindFiltersOnChange(){
            $(document).on('change','#selCity,#txtNoofguests,#dtFromDate,#dtToDate',function(){
                $('#divavilableunits').hide();
            });
        }
        var gb_cleaningfee = 0.0; var gb_bookingdays = 1;
        
        $(document).on('click','.btnNextToPayment',function(){
           
            if(objBooking.End_date__c != undefined && objBooking.Start_date__c != undefined && objBooking.End_date__c != null && objBooking.Start_date__c != null){
                var diftm = new Date(objBooking.End_date__c) - new Date(objBooking.Start_date__c);
                gb_bookingdays = Math.ceil(diftm / (1000 * 60 * 60 * 24));
            }
            
            var totalprice = ({!userModel.isStandardUser}) ? $('#bttotalprice').val() : $('#bttotalpriceText').html();
            totalprice = parseFloat(totalprice.replace('$',''));
            
            //here we need to check person record already exist to process booking
            console.log('call btnNextToPayment');
            let purposeofbooking = $('#purposeofbooking').val();
            
            if({!userModel.isStandardUser} && (purposeofbooking == undefined || purposeofbooking == null || purposeofbooking == "")){                    
               var d = getMessagebox();
                d = d.replace('{title}','Message');
                d = d.replace('{message}','<li>"Purpose of Booking" is required</li>');
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
                    
            }else if(totalprice > 0 && gb_cleaningfee > 0 && totalprice < gb_cleaningfee ){
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                d = d.replace('{message}','<li>Final Price has to be $0 or at least the amount of the cleaning fee!</li>');
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }
            else if(!tocheckblankactivity()){
                merge2Account(); // to merge acc records
            }else{
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                if(gb_req == 'leadsource'){
                    d = d.replace('{message}','<li>"Lead Source" is required.</li>');
                }else if(gb_req == 'desc'){
                    d = d.replace('{message}','<li>"Description" is required.</li>');
                }
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }

            
        });

        function fnbtnNextToPayment(){
            
            var firstname = $('#txtFirstName').val();
            var lastname = $('#txtLastName').val();
            var email = $('#txtEmail').val();
            var phone = $('#txtPhoneNumber').val();
            var startdate = $('#txtBookingStartDate').html();
            var enddate = $('#txtBookingEndDate').html();
            var totaltax = $('#txtTotalTaxed').val();
            var salesChannel = ({!userModel.isStandardUser}) ?$('#selSalesChannel').val() : 'manual';
            var totalprice = ({!userModel.isStandardUser}) ? $('#bttotalprice').val() : $('#bttotalpriceText').html();
            totalprice = parseFloat(totalprice.replace('$',''));
            
            $('div#ccPanel').hide();
            
            //email validation
            if(email != null && email != '' && !isValidEmail(email)){
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                d = d.replace('{message}','Please enter a valid email address.');
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }
            var isValidValue = false;            
            if({!!userModel.isStandardUser}){
                var conModel = JSON.parse('{!userModel.conModel}');
                if(conModel && conModel.contact != undefined){
                    var con = conModel.contact;                
                    if((con.FirstName || firstname) && (con.LastName || lastname) && (con.Email || email) && (con.Phone || phone)){
                        isValidValue = true;
                    }
                }                
            }else{
                isValidValue = true;
            }
            
            if( (isValidValue && ({!!userModel.isStandardUser} || (firstname != null && firstname != '' && lastname != null && lastname != '' && email != null && email != '' && phone != null && phone != '')) &&
                    startdate != null && startdate != '' && enddate != null && enddate != '') 
            ){
                objBooking.Total_taxed__c = parseFloat(totaltax);
                objBooking.Start_date__c = Date.parse(startdate); 
                objBooking.End_date__c = Date.parse(enddate);
                objBooking.Sales_channel__c = salesChannel;
                
                if({!userModel.isStandardUser}){
                    objBooking.Firstname__c = firstname;
                    objBooking.Lastname__c = lastname;
                    objBooking.Email__c = email;
                    objBooking.Phone_number__c = phone;                    
                }
                if(phone){
                    objBooking.Phone_number__c = phone;
                }
                if(firstname){
                    objBooking.Firstname__c = firstname;
                }
                if(email){
                    objBooking.Email__c = email;
                }
                if(lastname){
                    objBooking.Lastname__c = lastname;
                }
                $('div#bookingContent').hide();
                
                if($('a#booking') != undefined) {
                    $('a#booking').closest('li').removeClass('slds-is-current').addClass('slds-is-complete');
                }
                if($('a#payment') != undefined){
                    $('a#payment').closest('li').removeClass('slds-is-incomplete').addClass('slds-is-current');
                }
                $('div#paymentContent').show();
                if(salesChannel != 'manual'){
                    objBooking.External_code__c = $('#externalCode').val();
                } else if(salesChannel == 'manual'){
                    objBooking.External_code__c = salesChannel;
                }
                $('#cardsPanel').html('');
                $('#cardsPanel').hide();
                $("#bkmorethen30").hide();
                var totalDays = (objBooking.End_date__c-objBooking.Start_date__c)/(1000 * 3600 * 24);
                
                if(salesChannel != 'airbnb' && totalprice && totalprice>0){
                    $('div#ccPanel').show();
                    if(totalDays<=30 && savedCards != undefined && savedCards != null && savedCards.length>0){
                        var cardsHTML = '<h3 class="headingFont slds-section-title--divider" style="color:#227E8A;">Saved Card(s) from Last booking</h3><br/>';
                        for(var i=0; i<savedCards.length;i++){
                            var ccModel = savedCards[i];
                            selectedCardId = (ccModel.isDefaultSource ? ccModel.cardId : selectedCardId);
                            defaultSourceId = selectedCardId;
                            cardsHTML += '<div class="slds-grid container">'+
                                            '<div class="slds-col slds-size_12-of-12 sldsOverrightLineHeight">'+
                                                '<span class="slds-radio_button sldsfullwidth">'+
                                                    '<input '+(ccModel.isDefaultSource ? 'checked="true" ' : '')+'type="radio" id="'+ccModel.cardId+'" name="radioSavedCards" onclick="selectPaymentMethod(\''+ccModel.cardId+'\')" class="slds-radio"  />'+
                                                    '<label class="slds-radio_button__label sldsfullwidth slds-size_12-of-12" for="'+ccModel.cardId+'">'+
                                                        '<span class="slds-radio_faux radioLabel">'+
                                                            '<div class="slds-grid slds-wrap">'+
                                                                '<div class="slds-col slds-size_2-of-5 slds-x-small-size_1-of-1 slds-small-size_2-of-5 slds-m-vertical_x-small">'+
                                                                    '<span>'+ccModel.cardName+'</span>'+
                                                                '</div>'+
                                                                '<div class="slds-col slds-size_1-of-5 slds-x-small-size_1-of-1 slds-small-size_1-of-5 slds-m-vertical_x-small">'+
                                                                    '<span>XX'+ccModel.cardNumber+'</span>'+
                                                                '</div>'+
                                                                '<div class="slds-col slds-size_1-of-5 slds-x-small-size_1-of-1 slds-small-size_1-of-5 slds-m-vertical_x-small">'+
                                                                    '<span>'+ccModel.cardType+'</span>'+
                                                                '</div>'+
                                                               
                                                                '<div class="slds-col slds-size_1-of-5 slds-x-small-size_1-of-1 slds-small-size_1-of-5 slds-m-vertical_x-small">'+
                                                                    '<span>'+ccModel.expMonth+'/'+ccModel.expYear+'</span>'+
                                                                '</div>'+
                                                            '</div>'+
                                                        '</span>'+
                                                    '</label>'+
                                                '</span>'+
                                            '</div>'+
                                        '</div>';
                        }
                        $("#updateCardDetails").prop("checked",false);
                        $("#updateCardDetails").attr("disabled",false);
                        $('#cardsPanel').html(cardsHTML);
                        $('#cardsPanel').show();
                        $('#ccDetailPanel').hide();
                    }else{                    
                        $("#updateCardDetails").prop("checked",true);
                        $("#updateCardDetails").attr("disabled",true);
                        $('#ccDetailPanel').show();
                        selectedCardId = 'newCard';
                        
                        if(totalDays > 30){
                            $("#bkmorethen30").show();                            
                            //check first amount 
                            fncalculateBookUnitButtonAmount();                            
                        }
                    }
                }
            } else {
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                d = d.replace('{message}','All the details are required. Please fill all the details.');
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }
        };
        
        $(document).on("change","input[name='default']",function(){
            
            fncalculateBookUnitButtonAmount();
        });
        
        function fncalculateBookUnitButtonAmount(){
            
            $('#btnBookUnit').text('Book Unit');
            let totalDays = (objBooking.End_date__c-objBooking.Start_date__c)/(1000 * 3600 * 24);
            
            let totalprice = ({!userModel.isStandardUser}) ? $('#bttotalprice').val() : $('#bttotalpriceText').html();
            totalprice = parseFloat(totalprice.replace('$',''));
            
            let cleaningAmt = $('#btcleaningfee').html();
            cleaningAmt = parseFloat(cleaningAmt.replace('$',''));
            
            let ismonthtomonth = $('#rdmtm').is(':checked');
            
            
            if(totalprice > 0){
                let amt = (((totalprice - cleaningAmt) * 30) / parseFloat(totalDays));
                if(ismonthtomonth){
                    $('.clsbookunit').text('Book Unit $' + (Math.round(amt + cleaningAmt)).toFixed(2));
                }else{
                    $('.clsbookunit').text('Book Unit $' + (Math.round(totalprice)).toFixed(2));
                }                
            }
            
        };
        
        function selectPaymentMethod(cardId){
            selectedCardId = cardId;
            $("#updateCardDetails").prop("checked", false);
            $('#ccDetailPanel').hide();
        }
        function showHideCardPanel(){
            if($("#updateCardDetails").is(':checked')){
                selectedCardId = 'newCard';
                $('#ccDetailPanel').show();
                $("input[name='radioSavedCards']:checked").prop("checked",false);
            }else{
                $('#ccDetailPanel').hide();
                selectedCardId = '';
            }
        }
        /*$(document).on('click','.btnNextToBooking',function(){
            var selectedUnits = $(".chkUnit:checked");
            if(selectedUnits != null && selectedUnits.length > 0 && selectedUnits.length == 1) {
                selectedUnits.each(function(e){
                    var dataid = $(this).attr('data-id');
                    objBooking.Product__c = dataid;
                    var totalprice = $('[class=totalprice-'+dataid +']').attr('data-price');
                    var bookingComments = $('input[data-id='+dataid+']').attr('description');
                    objBooking.Total_taxed__c = totalprice;
                    objBooking.Booking_comment__c = bookingComments;
                    
                    var UnitName = $(this).attr('data-name');
                    var sub = $(this).attr('unitsubtotal');
                    var cleanfee = $(this).attr('unitcleaningfee');
                    var tax = $(this).attr('unittax');
                    totPrice = $(this).attr('data-totalPrice');
                    // var dis = $(this).attr('data-discount');
                    $('#pcunit').html(UnitName);
                    $('#pcsubtotal').html("$" + sub);
                    $('#pccleaningfee').html("$" + ((cleanfee != undefined || cleanfee != '') ? cleanfee : '0'));
                    $('#pctax').html("$" + tax);
                    // $('#pcdis').val();
                    $('#pctotalprice').html("$" + totPrice);
                    $('#bttotalprice').val(totPrice);
                    $('#btunit').html(UnitName);
                    $('#btsubtotal').html("$" + sub);
                    $('#btcleaningfee').html("$" + ((cleanfee != undefined || cleanfee != '') ? cleanfee : '0'));
                    $('#bttax').html("$" + tax);
                });
                objBooking.Status__c = 'Active';
                $('#txtBookingStartDate').html(objBooking.Start_date__c);
                $('#txtBookingEndDate').html(objBooking.End_date__c);
                $('#txtTotalTaxed').html(objBooking.Total_taxed__c);
                $('div#searchContent').hide();
                $('a#search').closest('li').removeClass('slds-is-current').addClass('slds-is-complete');
                $('a#booking').closest('li').removeClass('slds-is-incomplete').addClass('slds-is-current');
                $('div#bookingContent').show();
                $('.externalCodeDiv').hide();
            } else {
                var d = getMessagebox();
                d = d.replace('{title}','Message');
                if(selectedUnits != null && selectedUnits.length > 1) {
                    d = d.replace('{message}','You can not select more than one Unit.');
                } else {
                    d = d.replace('{message}','Please select at lease one Unit to Proceed Booking');
                }
                var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                d = d.replace('{cancelbutton}',btnclose);
                d = d.replace('{actionbutton}','');
                $('.slds').find('#divMessagebox').remove();
                $('.slds').append(d);
                $(this).blur();
                return false;
            }
            
        });*/
        $(document).on('click','.btnIndUnitBooking',function(){
            var dataid = $(this).attr('data-id');
            unitName = $(this).attr('data-name');
            objBooking.Product__c = dataid;
            var totalprice =  $(this).attr('data-totalPrice'); // $('td[class=totalprice-'+dataid +']').attr('data-price');
            var bookingComments = $(this).attr('description'); //$('input[data-id='+dataid+']').attr('description');
            objBooking.Total_taxed__c = totalprice;
            objBooking.Booking_comment__c = bookingComments;
            
            var UnitName = $(this).attr('data-name');
            unitPrice = !isNaN($(this).attr('unitsubtotal')) ? parseFloat($(this).attr('unitsubtotal')).toFixed(2) : 0.00;
            unitCleanfee =  !isNaN($(this).attr('unitcleaningfee')) ? parseFloat($(this).attr('unitcleaningfee')).toFixed(2) : 0.00;
            var tax = !isNaN($(this).attr('unittax')) ? parseFloat($(this).attr('unittax')).toFixed(2) : 0.00;
            var totPrice = !isNaN($(this).attr('data-totalPrice')) ? parseFloat($(this).attr('data-totalPrice')).toFixed(2) : 0.00;
            
            unitTax = !isNaN($(this).attr('data-unitTaxRate')) ? parseFloat($(this).attr('data-unitTaxRate')) : 0.00;
           
            var utype = $(this).attr('data-ut');
            var Neighborhood = $(this).attr('nghbrhd');
            var Noofguest = $('#txtNoofguests').val();
            // console.log(Neighborhood);
            // console.log(utype);
            // var dis = $(this).attr('data-discount');
            $('#pcunit').html(UnitName);
            $('#pcsubtotal').html("$" + unitPrice);
            $('#pccleaningfee').html("$" + unitCleanfee);
            $('#pctax').html("$" + tax);
            $('#pctotalprice').html("$" + totPrice);
            if({!userModel.isStandardUser}){
                $('#bttotalprice').val(totPrice);
                $('#pcTotalPriceRef').html("$" + unitPrice);
                $('#btTotalPriceRef').html("$" + unitPrice);
                $('#pcdis').html("0.00%");
            }else
                $('#bttotalpriceText').html("$" + totPrice);
            $('#btunit').html(UnitName);
            $('#btsubtotal').html("$" + unitPrice);
            $('#btcleaningfee').html("$" + unitCleanfee);
            $('#bttax').html("$" + tax);
            $('#btneighbor').html(Neighborhood);
            $('#btunittype').html(utype);
            $('#btguest').html(Noofguest+" guest");
            
            
            objBooking.Status__c = 'Active';
            $('#txtBookingStartDate').html(GetFormattedDate(objBooking.Start_date__c));
            $('#txtBookingEndDate').html(GetFormattedDate(objBooking.End_date__c));
            $('#txtTotalTaxed').html(objBooking.Total_taxed__c);
            $('div#searchContent').hide();
            $('a#search').closest('li').removeClass('slds-is-current').addClass('slds-is-complete');
            $('a#booking').closest('li').removeClass('slds-is-incomplete').addClass('slds-is-current');
            $('a#payment').closest('li').removeClass('slds-is-current').addClass('slds-is-incomplete');
            $('div#bookingContent').show();
            //$('.externalCodeDiv').hide();
        });
        
        function GetFormattedDate(dt) {
            var newdate = new Date(dt);
            var month = newdate.getMonth() + 1;
            var day = newdate.getDate();
            var year = newdate.getFullYear();
            return month + "/" + day + "/" + year;
        }
        
        if({!userModel.isStandardUser} && {!userModel.isBookingAllowed}){
            $(document).on('change','#selSalesChannel',function(){
                var selSalesChannel = $('#selSalesChannel').val();
                // console.log(selSalesChannel);
                if(selSalesChannel != 'manual'){
                    $('.externalCodeDiv').show();
                    $('.blankDiv').hide();
                } else {
                    $('.externalCodeDiv').hide();
                    $('.blankDiv').show();
                }
               
            });
        }
        $(document).on('click','.btnSearchUnit',function(){
            fnSearchUnit();
            $(this).blur();
            return false;
        });
        
        $(document).on('click','.btnClear',function(){
            $('#dtFromDate').val('');
            $('#dtToDate').val('');
            $('#selCity').val('');
            $('#txtNoofguests').val('1');
            $('#divavilableunits').hide();
            $('table.tblavailableunits').find('tbody').empty();
            $('div.divavailableunits').empty();

            //for sf1
            $('ul#ulavailableunits').empty();
        });
        function fnSearchUnit(){
            var showLink = ({!userModel.isStandardUser});
            var isBookingAllowed = ({!userModel.isBookingAllowed});
            var isInitSlider = false;

            if(isBookingAllowed){
                var dtFromDate = $('#dtFromDate').val();
                var dtToDate = $('#dtToDate').val();
                var city = $('#selCity').val();
                var Noofguest = $('#txtNoofguests').val();
                //var totalDays = (new Date(dtToDate)-new Date(dtFromDate))/(1000 * 3600 * 24);
               
                objBooking.Start_date__c = dtFromDate; 
                objBooking.End_date__c = dtToDate;
                objBooking.Travelers__c = Noofguest;
                var todayDate = (new Date()).setHours(0,0,0,0);  
                var errmsg = '';
                if((dtFromDate != undefined && (dtFromDate == null || dtFromDate == '')) || (dtToDate != undefined && (dtToDate == null || dtToDate == '')))
                {
                    errmsg = 'Please select date to search Unit.';
                }else if(Date.parse(dtToDate) <= Date.parse(dtFromDate))
                    errmsg = 'To Date should be greater than From Date.';
                else if({!!userModel.isStandardUser} && (new Date(dtFromDate) < todayDate || new Date(dtToDate) < todayDate)){
                    errmsg = 'From Date must be in present or future.';
                }
                if(errmsg){
                    var d = getMessagebox();
                    d = d.replace('{title}','Message');
                    d = d.replace('{message}',errmsg);
                    var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                    d = d.replace('{cancelbutton}',btnclose);
                    d = d.replace('{actionbutton}','');
                    $('.slds').find('#divMessagebox').remove();
                    $('.slds').append(d);
                    $(this).blur();
                    return false;
                }
                /*
                if((dtFromDate != undefined && (dtFromDate == null || dtFromDate == '')) || (dtToDate != undefined && (dtToDate == null || dtToDate == ''))){
                    var d = getMessagebox();
                    d = d.replace('{title}','Message');
                    d = d.replace('{message}','Please select date to search Unit.');
                    var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                    d = d.replace('{cancelbutton}',btnclose);
                    d = d.replace('{actionbutton}','');
                    $('.slds').find('#divMessagebox').remove();
                    $('.slds').append(d);
                    $(this).blur();
                    return false;
                }
                
                if(Date.parse(dtToDate) <= Date.parse(dtFromDate)){
                    var d = getMessagebox();
                    d = d.replace('{title}','Message');
                    d = d.replace('{message}','To Date should be greater than From Date.');
                    var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                    d = d.replace('{cancelbutton}',btnclose);
                    d = d.replace('{actionbutton}','');
                    $('.slds').find('#divMessagebox').remove();
                    $('.slds').append(d);
                    $(this).blur();
                    return false;
                }*/
                $('#divProcessing').show();
                $('#divavilableunits').show();
                
                $('ul#ulavailableunits').empty();
                $('table.tblavailableunits').find('tbody').empty();
                $('div.divavailableunits').empty();
                
                var temptr = temptr + '<tr><td>'+
                                        (
                                            showLink 
                                            ? '<a href="/{buildingid}" target="_blank"> {buildingname} </a>' 
                                            : '{buildingname}'
                                        )+
                                    '</td>';
                //adding unit virtual link to unit name
                
                //adding site url to redirect on record on site
                var sitename = '';
                if('{!$Site.Name}' != '')
                    sitename = '/{!$Site.Name}';
                temptr = temptr + '<td>'+
                                    (
                                        showLink 
                                        ? '<a href="'+sitename+'/{unitid}" target="_blank"> {unitname} </a>' 
                                        : '{Virtual_Tour_URL__c}'
                                    )+
                                '</td>';
                temptr = temptr + '<td>{unittype}</td><td>{neighbour}</td><td>${AvgPrice}</td><td>${ExtraGuestPrice}</td><td>${cleaningfee}</td><td>${tax}</td><td class="totalprice-{unitid}" data-price="{totalprice}">${totalprice}</td>';
                temptr = temptr + '<td align="center">\
                                  <button  data-id="{unitid}" description="{bookingcomments}" class="chkUnit btnIndUnitBooking slds-button {clsbook}" id="{unitid}" data-unitTaxRate="{unitTaxRate}"  unitsubtotal="{subtotal}" unittax="{tax}" unitcleaningfee="{cleaningfee}" data-name="{unit-name}" data-totalPrice="{total-price}" nghbrhd="{neighbour}" data-ut="{unittype}" disabled="{disable}">Book</button>\
                                </td></tr>';
                
                var templi = '<li class="slds-accordion__list-item"> \
                             <section class="slds-accordion__section"> \
                              <div class="slds-accordion__summary"> \
                                <h3 class="slds-accordion__summary-heading"> \
                                  <button class="headingFont slds-button slds-button_reset slds-accordion__summary-action btnAccordian"> \
                                    <svg class="slds-accordion__summary-action-icon slds-button__icon slds-button__icon_left" style="color:#227E8A;" > \
                                      <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.lightning, '/assets/icons/utility-sprite/svg/symbols.svg#switch')}" /> \
                                    </svg> \
                                    <span>{unitname}</span> \
                                  </button> \
                                </h3> \
                              </div> \
                              <div class="slds-accordion__content"><div style="padding:10px;background-color:#FAFAFA;">{unitcontent}</div></div> \
                            </section>';
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.UnitBookingController.allUnits}',city, dtFromDate, dtToDate, Noofguest, '', true, null, true,
                    function (result, event) {
                        $('#divProcessing').hide();
                        var index = 1;
                        if (event.status) {
                            if(result != undefined && result.length > 0){
                                $.map(result,function(unit,i){
                                    // added for css design change                                        
                                    var htmlBookinUnit = getUnitRecordsHTML(unit, index);
                                    $('div.divavailableunits').append(htmlBookinUnit);                                    
                                    isInitSlider = true
                                    // end of css design

                                    
                                    index++;
                                });

                                index--;
                                if({!userModel.isStandardUser}){
                                    $('.clsUnitURL').css({'cursor':'pointer'});
                                }
                                

                                var isSF1User = {!UserisOnSalesforce1};
                                if(isSF1User){
                                    if ( index % 2 != 0) {       
                                        $('div.divavailableunits').append('<div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12"></div>'); 
                                    }
                                }else{
                                    if ( index % 4 != 0) {
                                        var intmode4 = 4 - (index % 4);

                                        for (let index = 0; index < intmode4; index++) {
                                            $('div.divavailableunits').append('<div class="slds-col slds-large-size_1-of-4"></div>');                                            
                                        }
                                    }
                                }
                            } else {
                                
                                $('div.divavailableunits').append('<div class="slds-col slds-size_1-of-1 slds-medium-size_6-of-12 slds-large-size_3-of-12"><div class="slds-box"><p>No records to display.</p></div></div>')
                            }
                        } else if (event.type === 'exception') {
                            // alert(event.message + ' ' + event.where);
                            $('#divavilableunits').hide();
                            var d = getMessagebox();
                            d = d.replace('{title}','Error Message'+ ' :: ' + event.where);
                            d = d.replace('{message}',event.message);
                            var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
                            d = d.replace('{cancelbutton}',btnclose);
                            d = d.replace('{actionbutton}','');
                            $('.slds').find('#divMessagebox').remove();
                            $('.slds').append(d);
                            $(this).blur();
                            return false;
                        } else {
                            alert(event.message);
                            $('#divavilableunits').hide();
                        }

                        if(isInitSlider == true){
                            initSlider();
                        }
                            
                    },
                    { buffer: true, escape: true, timeout: 120000 }
                );
                //window.setTimeout(function() {
                //    $('#divProcessing').hide();
                //}, 2000);
            }
        }
        
        function initSlider(){
            
            $(".main-slider").slick({
              slidesToShow   : 1,
              infinite : false,
              dots     : true,
              arrows   : false,
              speed    : 300
            });

            $('.rateit').rateit({starwidth:12, starheight:11});

            setImageHeightAndWidthInAspectRation();
        }

        function replaceAll(str, find, replace) {
            return str.replace(new RegExp(find, 'g'), replace);
        }
        
        $(document).on('click','.btnAccordian',function(){
            var selected = false;
            if($(this).closest('.slds-accordion__list-item').hasClass('slds-is-open')){
                selected = true;
            }
            if(selected == false){
                $(this).closest('.slds-accordion__list-item').addClass('slds-is-open');
            } else {
                $(this).closest('.slds-accordion__list-item').removeClass('slds-is-open');
            }
        });
        function showPopup(title, msgs){
            var d = getMessagebox();
            d = d.replace('{title}',title);
            d = d.replace('{message}',msgs);
            var btnclose = '<button class="slds-button slds-button_neutral btnCloseMessagebox">Close</button>';
            d = d.replace('{cancelbutton}',btnclose);
            d = d.replace('{actionbutton}','');
            $('.slds').find('#divMessagebox').remove();
            $('.slds').append(d);
            $(this).blur();
            return false;
        }
        
        
        function isValidEmail(emailAddress) {
            var pattern = new RegExp(/^(("[\w-\s]+")|([\w-]+(?:\.[\w-]+)*)|("[\w-\s]+")([\w-]+(?:\.[\w-]+)*))(@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$)|(@\[?((25[0-5]\.|2[0-4][0-9]\.|1[0-9]{2}\.|[0-9]{1,2}\.))((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){2}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\]?$)/i);
            return pattern.test(emailAddress);
        };
        
        function isValidPhoneOREmail(){
            var email = $('#txtEmail').val();
            var phone = $('#txtPhoneNumber').val(); 
            var isError = false;
            //
            if((email == undefined || email.trim().length==0 || !isValidEmail(email)) &&
                (phone == undefined || phone.trim().length==0)) {
                isError = true;
            }
            return (!isError);
        }

        function applyMergeMessage(){
            $('.btnNextToPayment').removeAttr('disabled');
            $('.btnNextToPayment').removeClass('clsdisabledbtn');
            $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#success')}');
            $("#guestMessageBrand").removeClass('slds-theme_info');
            $("#guestMessageBrand").removeClass('slds-theme_warning');
            $("#guestMessageBrand").addClass('slds-theme_success');
            //$("#guestMessageBrand").attr('class','slds-notify slds-notify_toast slds-theme_success');
            $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('Record Merged Successfully!');
        }
        
        function applyGuestFoundMessage(){
            if(gbdatacon.isguestmessage != false){
                $('.btnNextToPayment').removeClass('clsdisabledbtn');
                $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#success')}');
                $("#guestMessageBrand").removeClass('slds-theme_info');
                $("#guestMessageBrand").removeClass('slds-theme_warning');
                $("#guestMessageBrand").addClass('slds-theme_success');
                //$("#guestMessageBrand").attr('class','slds-notify slds-notify_toast slds-theme_success');
                $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('Matching guest found');
            }
        }
            
        function applyGuestFoundMessagewithBlacklist(){
            if(gbdatacon.isguestmessage != false){
                $('.btnNextToPayment').attr('disabled','');
                $('.btnNextToPayment').addClass('clsdisabledbtn');
                $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#warning')}');
                $("#guestMessageBrand").removeClass('slds-theme_info');
                $("#guestMessageBrand").removeClass('slds-theme_warning');
                $("#guestMessageBrand").addClass('slds-theme_warning');
                //$("#guestMessageBrand").attr('class','slds-notify slds-notify_toast slds-theme_success');
                $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('Matching guest found -This customer has been blacklisted! We cannot allow blacklisted guests to stay with us!');
            }
        }

        function MessageForExistingGuest(strmsg){
            $('.btnNextToPayment').attr('disabled','');
            $('.btnNextToPayment').addClass('clsdisabledbtn');
            $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#warning')}');
            $("#guestMessageBrand").removeClass('slds-theme_success');
            $("#guestMessageBrand").removeClass('slds-theme_info');
            $("#guestMessageBrand").addClass('slds-theme_warning');
            $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").html(strmsg);
        }

        function applyGuestNotFoundMessage(){
            $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#info')}');
            $("#guestMessageBrand").removeClass('slds-theme_success');
            $("#guestMessageBrand").removeClass('slds-theme_warning');
            $("#guestMessageBrand").addClass('slds-theme_info');
            //$("#guestMessageBrand").attr('class','slds-notify slds-notify_toast slds-theme_info');
            $('.btnNextToPayment').removeClass('clsdisabledbtn');

            if(gb_recordfound){
                let aupadate = '<a id="acontactupedate" class="nounderline" href="javascript:void(0)"><b>update</b></a>';
                let anew = '<a id="acontactnew" class="nounderline" href="javascript:void(0)"><b>create a new</b></a>';
                let msg = 'No matching customer found! Would you like to ' + aupadate + ' the previously found customer or ' + anew + ' customer with these details?';

                $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").html(msg);
                $('.btnNextToPayment').attr('disabled','');
                $('.btnNextToPayment').addClass('clsdisabledbtn');
                console.log('do disabled');
            }else{
                $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('No record found, new guest will be created');
            }
        }

        $(document).on('click','#acontactupedate',function(){
            fncheckPhoneAndEmail(true);
        });

        $(document).on('click','#acontactnew',function(){
            savedCards = null;
            fncheckPhoneAndEmail(false);
        });

        function fncontactnewmethod(){
            $('.btnNextToPayment').removeClass('clsdisabledbtn');
            objBooking.Billing_Contact__c = null;
            $('.btnNextToPayment').removeAttr('disabled');
            $("#guestMessagePanel").hide();
        }

        function fncontactupdaterecodmethod(){
            $('.btnNextToPayment').removeClass('clsdisabledbtn');
            $('.btnNextToPayment').removeAttr('disabled');
            $("#guestMessagePanel").hide();
        }
    </script>
    
    <apex:outputPanel rendered="{!userModel.isStandardUser}">
        <script>

        var gbcontactrecord = {}; var gbdatacon = {};

        function fncheckPhoneAndEmail(IsCallFromUpdateLink){
            //debugger;
                var email = $('#txtEmail').val();
                var phone = $('#txtPhoneNumber').val();                
                if(isValidPhoneOREmail()){

                    $('#divProcessing').show();
                    $('#cardsPanel').html('');                    
                    if(phone != undefined && phone.length >0) phone = phone.replace(/\D+/g, "");    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.UnitBookingController.searchContactFornew}', email, phone ,
                        function (result, event) {
                            if (event.status) {
                                if(result != undefined && result != null){
                                    
                                    if(result.length > 0){

                                        if(IsCallFromUpdateLink){
                                            //check booking contact id != result contact id
                                            let blnnotmatch = false;
                                            result.forEach(c => {
                                                if(c.Id != objBooking.Billing_Contact__c){
                                                    blnnotmatch = true;
                                                }
                                            });

                                            if(blnnotmatch){
                                                $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#warning')}');
                                                $("#guestMessageBrand").removeClass('slds-theme_success');
                                                $("#guestMessageBrand").removeClass('slds-theme_info');
                                                $("#guestMessageBrand").addClass('slds-theme_warning');
                                                $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('We already have another customer with the same email/phone number! Please provide a non-existing Email/Phone to create a new Customer.');
                                            }else{
                                                fncontactupdaterecodmethod();
                                            }
                                            
                                        }else{
                                            $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, 'assets/icons/utility-sprite/svg/symbols.svg#warning')}');
                                            $("#guestMessageBrand").removeClass('slds-theme_success');
                                            $("#guestMessageBrand").removeClass('slds-theme_info');
                                            $("#guestMessageBrand").addClass('slds-theme_warning');
                                            $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").text('We already have another customer with the same email/phone number! Please provide a non-existing Email/Phone to create a new Customer.');
                                        }

                                        
                                    }else{
                                        if(IsCallFromUpdateLink){
                                            fncontactupdaterecodmethod();
                                        }else{
                                            fncontactnewmethod();
                                        }
                                        
                                    }                                                                        
                                }
                            } else if (event.type === 'exception') {
                                //showPopup('Error Message',event.message + ' :: ' + event.where);
                            }
                            
                            $('#divProcessing').hide();
                        },
                        { buffer: true, escape: true, timeout: 120000 }
                    );
                }
            };

            function merge2Account(){
                let masterid = gbdatacon.masterid;
                let childid = gbdatacon.mergeid;
                $('#divProcessing').show();

                if(gbdatacon.ismerge != true && gbdatacon.isrunmerge == true){
                    Visualforce.remoting.Manager.invokeAction('{!$RemoteAction.UnitBookingController.mergecontact}', masterid, childid,
                        function (result, event) {                        
                            if (event.status) {
                                if(result != undefined && result != null){
                                    if(result.MessageStatus == 'SUCCESS'){
                                        objBooking.Billing_Contact__c = result.masterId;
                                        gb_recordfound = true;
                                        gbdatacon.ismerge = true;
                                        fnbtnNextToPayment();
                                    }else{
                                        showPopup('Error Message', result.MessageText);
                                    }
                                }
                            } else if (event.type === 'exception') {
                                showPopup('Error Message', event.message);
                            } 
                            $('#divProcessing').hide();
                        },
                        { buffer: true, escape: true, timeout: 120000 }
                    );
                }
                else{
                    //debugger;
                    //need to check validation rule
                    /*var setofUser = new GSet();
                    setofUser.add('support@barsala.com');
                    setofUser.add('michael@barsala.com');
                    setofUser.add('eugene@barsala.com');
                    setofUser.add('jade@barsala.com');
                    setofUser.add('kristen@barsala.com');
                    //setofUser.add('ronald@barsala.com');
                    setofUser.add('kelly@barsala.com');
                    setofUser.add('maria@barsala.com');
                    setofUser.add('ksenia@barsala.com');
                    //setofUser.add('sean@barsala.com');
                    setofUser.add('brzowski@barsala.com');
                    setofUser.add('mcopley@barsala.com');
                    setofUser.add('aaron@barsala.com');
                    setofUser.add('hussein@barsala.com');
                    
                    var setofProfile = new GSet();
                    setofProfile.add('Engineering Team');
                    setofProfile.add('City Manager');
                    
                    let cusprofile = '{!$Profile.Name}';
                    
                    let cuEmail = '{!$User.Email}';
                    var dtFromDate = $('#dtFromDate').val();
                    var dtToDate = $('#dtToDate').val();
                    
                    let edt = Date.parse(dtToDate);
                    let sdt = Date.parse(dtFromDate);
                    let today = Date.parse(new Date());
                    let blnIsError = false;
                    let duration = (edt-sdt)/(1000 * 3600 * 24);
                    let discount = $('#discount').val();
                    if(discount != "" &&  !isNaN(discount)  && !setofUser.contains(cuEmail.toLowerCase()) && !setofProfile.contains(cusprofile) && edt > today ){
                        let discompareval = discount/100;
                        if(discompareval > 0.10 && duration<30){
                            blnIsError = true;
                        }
                        else if(discompareval > 0.20 && duration>29){
                            blnIsError = true;
                        }
                    }
                    
                    $("#guestMessagePanel").hide();
                    if(blnIsError){
                        
                        let strmsg = 'For bookings under 30 days, the max discount is 5-10% (10% with approval). For bookings over 30 days, the max discount is 15-20%. Units cannot be blocked without mgmt approval.';
                        
                        $("#guestMessageIcon").attr('xlink:href','{!URLFOR($Resource.lightning, "assets/icons/utility-sprite/svg/symbols.svg#warning")}');
                        $("#guestMessageBrand").removeClass('slds-theme_success');
                        $("#guestMessageBrand").removeClass('slds-theme_info');
                        $("#guestMessageBrand").addClass('slds-theme_error');
                        $("#guestMessagePanel .slds-notify__content .slds-text-heading_small").html(strmsg);
                        $("#guestMessagePanel").show();
                        //fnbtnNextToPayment();
                    }else{
                        $("#guestMessageBrand").removeClass('slds-theme_error');
                        fnbtnNextToPayment();
                    }
                    $('#divProcessing').hide();*/
                    $("#guestMessageBrand").removeClass('slds-theme_error');
                    fnbtnNextToPayment();
                    $('#divProcessing').hide();
                }
                
            };

            var gb_recordfound = false;
            $(document).on('change','#txtPhoneNumber',function(){ 
                $("#guestMessageBrand").removeClass('slds-theme_error');
                $('.btnNextToPayment').removeAttr('disabled');

                var email = '';
                var phone = $('#txtPhoneNumber').val(); 
                var fieldId = $(this).attr('id');//this.id
                var thisValue = $(this).val();//this.value
                //if(isValidPhoneOREmail() && (objBooking.Billing_Contact__c == undefined || objBooking.Billing_Contact__c == null)){
                if(isValidPhoneOREmail() && phone != ""){
                    $('#divProcessing').show();
                    $('#cardsPanel').html('');
                    
                    if(phone != undefined && phone.length >0) phone = phone.replace(/\D+/g, "");

                    if(gbdatacon.isguestmessage == false){
                        gbdatacon.isguestmessage = true;
                    }
    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.UnitBookingController.searchContact}', email, phone ,
                        function (result, event) {
                            if (event.status) {
                                if(result != undefined && result != null){
                                    if(gb_recordfound){
                                        if(result.contact.Id != gbcontactrecord.Id){
                                            let con1fname = gbcontactrecord.FirstName ? gbcontactrecord.FirstName : '';
                                            let con1lname = gbcontactrecord.LastName ? gbcontactrecord.LastName : '';
                                            var con1 = '<b data-id="' + gbcontactrecord.Id + '" class="clsContact" data-email="' + gbcontactrecord.Email + '" data-phone="' + gbcontactrecord.Phone + '">' + con1fname + ' ' + con1lname + '</b>';

                                            let con2fname = result.contact.FirstName ? result.contact.FirstName : '';
                                            let con2lname = result.contact.LastName ? result.contact.LastName : '';
                                            var con2 = '<b data-id="' + result.contact.Id + '" class="clsContact" data-email="' + result.contact.Email + '" data-phone="' + result.contact.Phone + '" >' + con2fname + ' ' + con2lname + '</b>';
                                            var mrg = '<a href="javascript:void(0);" data-masterconid="' + gbcontactrecord.Id + '" data-mergeconid="' + result.contact.Id + '" class="clsmergecontact"><b>merge</b></a>';                                            
                                            //MessageForExistingGuest('We already have another customer with the same phone number!');
                                            //MessageForExistingGuest('Found two contacts with provided information, we will merge them upon booking creation: ' + con1 + ' and '+ con2 + '');
                                            
                                            MessageForExistingGuest('Is this reservation for ' + con1 + ' or '+ con2 + "? If so, click on their name above to populate the correct information. <div><b>IMPORTANT:</b> If you don't select one of the accounts above, these two will be merged.</div>");

                                           
                                            
                                            $('.btnNextToPayment').removeAttr('disabled');
                                            $('.btnNextToPayment').removeClass('clsdisabledbtn');

                                            gbdatacon.masterid = gbcontactrecord.Id;
                                            gbdatacon.mergeid = result.contact.Id;
                                            gbdatacon.isrunmerge = true;
                                        }else if(result.contact.Id == gbcontactrecord.Id){
                                            objBooking.Billing_Contact__c = result.contact.Id;
                                            savedCards = result.ccModelList;
                                            gbdatacon.isguestmessage = false;
                                        }
                                        
                                    }
                                    else{
                                        var con = result.contact;
                                        gbcontactrecord = con;
                                        savedCards = result.ccModelList;
                                        if(con.FirstName && con.FirstName.trim().length>0){
                                            $('#txtFirstName').val(con.FirstName);
                                        }
                                        $('#txtLastName').val(con.LastName);    
                                        if(con.Email && con.Email.trim().length>0 && 
                                            (
                                                fieldId!='txtEmail' ||
                                                (thisValue && thisValue.trim().length==0)
                                            )
                                        ){
                                            $('#txtEmail').val(con.Email);
                                        }
                                        
                                        if(con.Phone && con.Phone.trim().length>0 && 
                                            (
                                                fieldId!='txtPhoneNumber' ||
                                                (thisValue && thisValue.trim().length==0)
                                            )
                                        ){
                                            $('#txtPhoneNumber').val(con.Phone); 
                                        }
                                        objBooking.Billing_Contact__c = con.Id;
                                        
                                        if(con.Screening_Decision__c == 'Blacklist'){
                                            gbdatacon.isguestmessage = true;
                                            applyGuestFoundMessagewithBlacklist();
                                        }
                                        else{
                                            applyGuestFoundMessage();
                                        }
                                        
                                        gb_recordfound = true;
                                    }
                                    
                                }else{ 
                                    //objBooking.Billing_Contact__c = null;  
                                    
                                    //savedCards = null;
                                    applyGuestNotFoundMessage();
    
                                    //$('#txtFirstName').val('');
                                    //$('#txtLastName').val('');
    
                                    /*$('#txtEmail').val(email);
                                    $('#txtPhoneNumber').val(phone); 
                                    
                                    showPopup('Message', 'No matching record found.');*/
                                } 
    
                                if(gbdatacon.isguestmessage != false){
                                    $("#guestMessagePanel").show();
                                }
                                
                                topopulatetask();
                                
                            } else if (event.type === 'exception') {
                                //showPopup('Error Message',event.message + ' :: ' + event.where);
                            } else {
                                //alert(event.message);
                            }
                            //$('div#guestPanel').show();
                            //$('.btnNextToPayment').show();
                            $('#divProcessing').hide();
                        },
                        { buffer: true, escape: true, timeout: 120000 }
                    );
                }
                /*else{
                    objBooking.Billing_Contact__c = null;
                }*/
            });

            $(document).on('click', '.clsContact', function(){                  
                
                let email = $(this).attr('data-email');  
                let phone = $(this).attr('data-phone');
                let contactid = $(this).attr('data-id');
                
                $('.btnResetGuest').trigger('click');

                if(email != undefined){
                    
                    $('#txtEmail').val(email);
                    $('#txtEmail').trigger('change');
                }else if(phone != undefined){
                    $('#txtPhoneNumber').val(phone);
                    $('#txtPhoneNumber').trigger('change');
                }

                gbdatacon.isguestmessage = false;
            });
            
            var gb_req = '';
            function tocheckblankactivity(){
                gb_req = '';
                let strtaskid = $('#recenttask').val();
                let phone = $('#txtPhoneNumber').val();                
                let blnIsError = false;
                
                let phonelen = 0;                
                if(phone != undefined && phone != null && phone != ''){
                    phonelen = phone.length;
                }
                if({!userModel.isStandardUser} && phonelen > 0){
                    if(strtaskid == undefined || strtaskid == null || strtaskid == ''){
                        blnIsError = true;
                        gb_req = 'leadsource';
                    }
                    if(strtaskid != undefined && strtaskid != null && strtaskid != '' && strtaskid == 'Other'){
                        let lsdesc = $('#leadsourcedescription').val();  
                        if(lsdesc == undefined || lsdesc == null || lsdesc == ''){
                            blnIsError = true;
                            gb_req = 'desc';
                        }
                    }
                }
                return blnIsError;
            };
            
            
            $(document).on('change','#recenttask',function(){

                let strval = $(this).val();
                $('#divleadsourcedescription').hide();
                if(strval == 'Other'){
                    $('#divleadsourcedescription').show();
                }
                
                objBooking.Lead_Source__c = null;
                if(strval != undefined && strval != null && strval != ""){
                    objBooking.Lead_Source__c = strval;
                }
                
            });
            
            function topopulatetask(){ 
               
                let phone = $('#txtPhoneNumber').val();
                $(".clsShowHideActivity" ).hide();
                let phonelen = 0;
                
                if(phone != undefined && phone != null && phone != ''){
                    phonelen = phone.length;
                }
                
                if({!userModel.isStandardUser} && phonelen > 0){
                    
                    let conid = objBooking.Billing_Contact__c;
                    if(conid == undefined || conid == ""){
                        conid = null;
                    }

                    Visualforce.remoting.Manager.invokeAction(
                            '{!$RemoteAction.UnitBookingController.findAllLeadSource}', 
                            function (result, event) {
                                if (event.status) {
                                    if(result != undefined && result != null){
                                        $('#recenttask').empty();
                                        $('#recenttask').append('<option value="">-- Select --</option>');
                                        let selectedval = "";
                                        $(result).map(function(idx,o){                                            
                                            $('#recenttask').append('<option value="' + o.value + '">' + o.text + '</option>');
                                            
                                        });
                                        //$('#recenttask').append('<option value="N/A">N/A</option>');                                        
                                        //setTimeout(function(){ $('#recenttask').val(selectedval); }, 100);
                                        $(".clsShowHideActivity" ).show();
                                    }
                                }else if (event.type === 'exception') {
                                    alert('Error Message',event.message + ' :: ' + event.where);
                                } else {
                                    //alert(event.message);
                                }
                                
                                $('#divProcessing').hide();
                            },
                            { buffer: true, escape: true, timeout: 120000 }
                        );
                    
                }
            };
        
            $(document).on('change','#txtEmail',function(){
                
                $("#guestMessageBrand").removeClass('slds-theme_error');
                $('.btnNextToPayment').removeAttr('disabled');
                var email = $('#txtEmail').val();
                var phone = ''; 
                var fieldId = $(this).attr('id');//this.id
                var thisValue = $(this).val();//this.value
                //if(isValidPhoneOREmail() && (objBooking.Billing_Contact__c == undefined || objBooking.Billing_Contact__c == null)){
                if(isValidPhoneOREmail() && email != ""){
                    $('#divProcessing').show();
                    $('#cardsPanel').html('');
                    
                    if(phone != undefined && phone.length >0) phone = phone.replace(/\D+/g, "");

                    if(gbdatacon.isguestmessage == false){
                        gbdatacon.isguestmessage = true;
                    }
    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.UnitBookingController.searchContact}', email, phone ,
                        function (result, event) {
                            if (event.status) {
                                //debugger;
                                if(result != undefined && result != null){

                                    if(gb_recordfound){
                                        if(result.contact.Id != gbcontactrecord.Id){
                                            let con1fname = gbcontactrecord.FirstName ? gbcontactrecord.FirstName : '';
                                            let con1lname = gbcontactrecord.LastName ? gbcontactrecord.LastName : '';
                                            var con1 = '<b data-id="' + gbcontactrecord.Id + '" data-email="' + gbcontactrecord.Email + '" data-phone="' + gbcontactrecord.Phone + '"  class="clsContact">' + con1fname + ' ' + con1lname + '</b>';

                                            let con2fname = result.contact.FirstName ? result.contact.FirstName : '';
                                            let con2lname = result.contact.LastName ? result.contact.LastName : '';
                                            var con2 = '<b data-id="' + result.contact.Id + '" class="clsContact" data-email="' + result.contact.Email + '" data-phone="' + result.contact.Phone + '" >' + con2fname + ' ' + con2lname + '</b>';
                                            var mrg = '<a href="javascript:void(0);" data-masterconid="' + gbcontactrecord.Id + '" data-mergeconid="' + result.contact.Id + '" class="clsmergecontact"><b>merge</b></a>';
                                            //MessageForExistingGuest('We already have another customer with the same email!');
                                            //MessageForExistingGuest('Found two contacts with provided information, we will merge them upon booking creation: ' + con1 + ' and '+ con2 + '');

                                            MessageForExistingGuest('Is this reservation for ' + con1 + ' or '+ con2 + "? If so, click on their name above to populate the correct information. <div><b>IMPORTANT:</b> If you don't select one of the accounts above, these two will be merged.</div>");
                                            
                                            
                                            
                                            
                                            
                                            $('.btnNextToPayment').removeAttr('disabled');
                                            $('.btnNextToPayment').removeClass('clsdisabledbtn');

                                            gbdatacon.masterid = gbcontactrecord.Id;
                                            gbdatacon.mergeid = result.contact.Id;
                                            gbdatacon.isrunmerge = true;
                                            
                                            
                    
                                        }else if(result.contact.Id == gbcontactrecord.Id){
                                            objBooking.Billing_Contact__c = result.contact.Id;
                                            savedCards = result.ccModelList;
                                            gbdatacon.isguestmessage = false;
                                        }
                                        
                                    }
                                    else{
                                        var con = result.contact;
                                        gbcontactrecord = con;
                                        savedCards = result.ccModelList;
                                        if(con.FirstName && con.FirstName.trim().length>0){
                                            $('#txtFirstName').val(con.FirstName);
                                        }
                                        $('#txtLastName').val(con.LastName);        
                                        if(con.Email && con.Email.trim().length>0 && 
                                            (
                                                fieldId!='txtEmail' ||
                                                (thisValue && thisValue.trim().length==0)
                                            )
                                        ){
                                            $('#txtEmail').val(con.Email);
                                        }                                        
                                        if(con.Phone && con.Phone.trim().length>0 && 
                                            (
                                                fieldId!='txtPhoneNumber' ||
                                                (thisValue && thisValue.trim().length==0)
                                            )
                                        ){
                                            $('#txtPhoneNumber').val(con.Phone);
                                        }
                                        objBooking.Billing_Contact__c = con.Id;                                        
                                        if(con.Screening_Decision__c == 'Blacklist'){
                                            gbdatacon.isguestmessage = true;
                                            applyGuestFoundMessagewithBlacklist();
                                        }
                                        else{
                                            applyGuestFoundMessage();
                                        }
                                        gb_recordfound = true;
                                    }
                                }else{ 
                                    //objBooking.Billing_Contact__c = null;  
                                    
                                    //savedCards = null;
                                    applyGuestNotFoundMessage();
    
                                    //$('#txtFirstName').val('');
                                    //$('#txtLastName').val('');
    
                                    /*$('#txtEmail').val(email);
                                    $('#txtPhoneNumber').val(phone); 
                                    
                                    showPopup('Message', 'No matching record found.');*/
                                } 
                                
                                if(gbdatacon.isguestmessage != false){
                                    $("#guestMessagePanel").show();
                                }
                                topopulatetask();
                            } else if (event.type === 'exception') {
                                //showPopup('Error Message',event.message + ' :: ' + event.where);
                            } else {
                                //alert(event.message);
                            }
                            //$('div#guestPanel').show();
                            //$('.btnNextToPayment').show();
                            $('#divProcessing').hide();
                        },
                        { buffer: true, escape: true, timeout: 120000 }
                    );
                }
                /*else{
                    objBooking.Billing_Contact__c = null;
                }*/
            });
            
            $(document).on('click','.btnResetGuest',function(){
                //resetting search panel guest details
                //$('#txtEmailSearch').val('');
                //$('#txtPhoneNumberSearch').val('');
    
                //resetting guest details
                $('#txtFirstName').val('');
                $('#txtLastName').val('');
                $('#txtEmail').val('');
                $('#txtPhoneNumber').val(''); 
                $('#recenttask').val('');
                $(".clsShowHideActivity" ).hide();
    
                //blanking contact id in booking
                objBooking.Billing_Contact__c = null;
                gbcontactrecord = {};
                gbdatacon = {};
                gb_recordfound = false;
                //removing the message at top
                $("#guestMessagePanel").hide();
            });
            
        </script>
        
    </apex:outputPanel>

    <script>
        function getUnitRecordsHTML(unit, index){                
                var avunits = '';
                var isSF1User = {!UserisOnSalesforce1};

                avunits = '<div class="slds-col {mobile-desktop-class}"><div class="slds-box"><div>{Virtual_Tour_URL__c}</div><div data-unitId="{unitid}" class="clsPrimayColor clsUnitURL">{unitname}</div><div class="clsfnt14">{neighbour}</div><div class="clsfnt14">{unittype}</div><div class="slds-m-top_x-small "><b class="clsfnt16">${total-price}</b><span class="clsfnt14"> / Night</span></div><div>{startrating}</div><div>{bookbutton}</div></div></div>';

                // avunits = '<div class="slds-col slds-size_1-of-1  slds-large-size_1-of-12"><div class="slds-box"><div>{Virtual_Tour_URL__c}</div><div class="clsPrimayColor"><b>{unitname}</b></div><div>{neighbour}</div><div>{unittype}</div><div><b>${total-price}</b></div><div>{bookbutton}</div></div></div>';
                if(isSF1User){
                    avunits = replaceAll(avunits,'{mobile-desktop-class}','slds-size_1-of-1 slds-medium-size_6-of-12');
                }else{
                    avunits = replaceAll(avunits,'{mobile-desktop-class}','slds-large-size_1-of-4');
                }
                avunits = replaceAll(avunits,'{unitid}',unit.UnitId);
                avunits = avunits.replace('{unitname}',unit.UnitName);
                avunits = replaceAll(avunits,'{unittype}',unit.UnitType);
                //avunits = replaceAll(avunits,'{total-price}',unit.TotalPrice);
                avunits = replaceAll(avunits,'{total-price}',(unit.AvgPrice ? parseFloat(unit.AvgPrice).toFixed(2) : 0))
                avunits = replaceAll(avunits,'{neighbour}',(unit.Neighborhood != undefined ? unit.Neighborhood : ''));

                var unitcnt = '';
                //debugger;
                //if(unit.VirtualTourURL || (unit.images && unit.images.length>0)){
                if((unit.images && unit.images.length>0)){
                    unitcnt += '<div class="main-slider ">';
                    if(unit.VirtualTourURL){
                        // unitcnt += '<a class="virtualTourcontainer" style="height:200px;" data-fancybox="group'+index+'" data-type="iframe" data-src="'+unit.VirtualTourURL+'&play=1" href="javascript:;"><image src="'+unit.VirtualTourThumb+'" style="width:100%;height:100%" class="clsVirtualTourURL"/> <img src="{!URLFOR($Resource.play_icon)}" class="playOverlay"/></a>';

                        // unitcnt += '<div class="virtualTourcontainer"><img src="'+unit.VirtualTourThumb+'" style="width:100%;" class="clsVirtualTourURL clsimgset" title="Book Now" dataidx="' + index + '" /> <a data-fancybox="group'+index+'" data-type="iframe" data-src="'+unit.VirtualTourURL+'&play=1" href="javascript:;"><img src="{!URLFOR($Resource.play_icon)}" class="playOverlay"/></a></div>';

                    } 
                    
                    var unitimglimit = '{!UnitImageThreshold}';
                    var totalunitimglimit = 0;
                    if(unitimglimit != ''){
                        totalunitimglimit = parseInt(unitimglimit);
                    }

                    if(unit.images && unit.images.length>0){
                        for(var i=0; i<unit.images.length;i++){
                            if(i == totalunitimglimit){
                                break;
                            }
                            // unitcnt += '<div><a  data-fancybox="group'+index+'" data-type="image" data-src="'+unit.images[i].imageURL+'" href="javascript:;"><image class="clsimgset" src="'+unit.images[i].thumbnailURL+'" style="width:100%;" /></a></div>';

                            if(i == 0){
                                unitcnt += '<div class="virtualTourcontainer"><img src="'+unit.images[i].thumbnailURL+'" style="width:100%;" class="clsVirtualTourURL clsimgset" title="Book Now" dataidx="' + index + '" /> <a data-fancybox="group'+index+'" data-type="iframe" data-src="'+unit.VirtualTourURL+'&play=1" href="javascript:;"><img src="{!URLFOR($Resource.play_icon)}" class="playOverlay"/></a></div>';
                            }else{
                                unitcnt += '<div class="virtualTourcontainer"><img src="'+unit.images[i].thumbnailURL+'" style="width:100%;" class="clsVirtualTourURL clsimgset" title="Book Now" dataidx="' + index + '" /> <a data-fancybox="group'+index+'" data-type="image" data-src="'+unit.images[i].imageURL+'&play=1" href="javascript:;"><img src="{!URLFOR($Resource.play_icon)}" class="playOverlay"/></a></div>';
                            }

                            

                            //  unitcnt += '<div class="virtualTourcontainer"><img src="'+unit.images[i].thumbnailURL+'" style="width:100%;" class="clsVirtualTourURL clsimgset" title="Book Now" dataidx="' + index + '" /> <a data-fancybox="group'+index+'" data-type="image" data-src="'+unit.images[i].imageURL+'&play=1" href="javascript:;"></a></div>';
                        }
                    }

                    unitcnt += '</div>';
                }else{
                    unitcnt += '<div class="slidermaxwidth">';
                    unitcnt += '<div class="virtualTourcontainer" ><img class="clsVirtualTourURL clsimgset" title="Book Now" src="{!URLFOR($Resource.NoImage)}" style="width:100%;" dataidx="' + index + '" /> </div>';
                    unitcnt += '<div style="padding:6px;">&nbsp;</div>';
                    // <img src="{!URLFOR($Resource.play_icon)}" class="playOverlay"/>
                    unitcnt += '</div>';
                }

                avunits = avunits.replace('{Virtual_Tour_URL__c}',unitcnt);

                if(unit.AvgPrice != '' && unit.AvgPrice >= 0){
                    var btn = '<button style="display:none;" dataidx="' + index + '"  data-id="{unitid}" description="{bookingcomments}" class="chkUnit btnIndUnitBooking slds-button slds-button--brand {clsbook}" id="{unitid}" unitsubtotal="{subtotal}" unittax="{tax}" data-unitTaxRate="{unitTaxRate}" unitcleaningfee="{cleaningfee}" data-name="{unit-name}" data-totalPrice="{total-price}" nghbrhd="{neighbour}" data-ut="{unittype}" >BOOK NOW</button>';
                    btn = replaceAll(btn ,'{unitid}',unit.UnitId);
                    btn = btn.replace('{bookingcomments}',unit.BookingComments);
                    btn = btn.replace('{subtotal}',unit.SubTotal);
                    btn = btn.replace('{tax}',unit.TotalTax).replace('{tax}',unit.TotalTax);
                    btn = btn.replace('{cleaningfee}',unit.CleaningFee);
                    btn = btn.replace('{unit-name}',unit.UnitName);
                    btn = btn.replace('{total-price}',unit.TotalPrice);
                    btn = btn.replace('{unittype}',unit.UnitType)
                    btn = btn.replace('{neighbour}',(unit.Neighborhood != undefined ? unit.Neighborhood : ''));
                    btn = btn.replace('{unitTaxRate}',unit.TaxRate);
                    avunits = avunits.replace('{bookbutton}',btn);                    
                }                    
                
                if(unit.AvgPrice == 0 || unit.AvgPrice == ''){
                    avunits = avunits.replace('{disable}',"true");
                    avunits = avunits.replace('{clsbook}','slds-button_neutral')
                } else {
                    avunits = avunits.replace('disabled="{disable}"','');
                    avunits = avunits.replace('{clsbook}','slds-button--brand');
                }
                
                //newtr = newtr.replace('{AvgPrice}',(unit.AvgPrice ? (unit.AvgPrice) : 0));
                var unitstarrating = '{!avgRating}'
                var totalunitstarrating = 0;
                if(unitstarrating != ''){
                    totalunitstarrating = parseFloat(unitstarrating);                        
                }
                console.debug('totalunitstarrating@@@' + totalunitstarrating);

                if(unit.starRating >= totalunitstarrating){
                    avunits = avunits.replace('{startrating}','<div><span class="rateit clsfnt16" data-rateit-value="' + unit.starRating  + '" data-rateit-ispreset="true" data-rateit-readonly="true"></span><span class="clsRatingReview clsfnt14">(<b class="clsfontsize">' + unit.noOfReviews + '</b> reviews)</span></div>');
                }else{
                    avunits = avunits.replace('{startrating}','');
                }

                return avunits;
            }

            $(document).on('click','.clsUnitURL',function(obj){
                var siteprefix = '{!$Site.Prefix}';
                var isSF1User = {!UserisOnSalesforce1};
                if(isSF1User){
                    //sforce.one.navigateToSObject($(this).attr('data-unitId')); 
                }else{
                    if(siteprefix != undefined && siteprefix != '' && siteprefix.toLowerCase().indexOf('customer') != -1 ){

                    }else{
                        window.open(siteprefix + '/' + $(this).attr('data-unitId'), '_blank' );
                    }                    
                }
            });
            var gb_imgurl; var gbimgobject;
            $(document).on('click','.clsVirtualTourURL',function(e){
                e.preventDefault();
                gbimgobject = $(this).closest('div.main-slider');
                gb_imgurl = $(this).attr('src');
                var idx = $(this).attr('dataidx');
                $('button[dataidx=' + idx + ']').click();
            });

           

            // $(window).load(function(){
            //     setImageHeightAndWidthInAspectRation();
            // });

            //  $(window).resize(function(){
            //     setImageHeightAndWidthInAspectRation();
            // });

            $(window).on("load resize",function(e){
                setImageHeightAndWidthInAspectRation();
            });

            function setImageHeightAndWidthInAspectRation() {
                try {
                    let imgarr = $('.clsimgset');

                    for (let index = 0; index < imgarr.length; index++) {                        
                        let objImg = imgarr[index];
                        let tmpMaxWidth = $('.virtualTourcontainer').css('width').replace('px','');
                        
                        var maxWidth = parseFloat(tmpMaxWidth); // Max width for the image
                        var maxHeight = (maxWidth*9)/16;    // Max height for the image

                        $(objImg).css("height", maxHeight);   // Set new height
                        //$(objImg).css("width", width * ratio); 

                        // var ratio = 0;  // Used for aspect ratio
                        // var width = objImg.naturalWidth;    // Current image width
                        // var height = objImg.naturalHeight;  // Current image height

                        // // Check if the current width is larger than the max
                        // if (width > maxWidth) {
                        //     ratio = maxWidth / width;   // get ratio for scaling image
                        //     $(objImg).css("width", maxWidth); // Set new width
                        //     $(objImg).css("height", height * ratio);  // Scale height based on ratio
                        //     height = height * ratio;    // Reset height to match scaled image
                        //     width = width * ratio;    // Reset width to match scaled image
                        // }

                        // // Check if current height is larger than max
                        // if (height > maxHeight) {
                        //     ratio = maxHeight / height; // get ratio for scaling image
                        //     $(objImg).css("height", maxHeight);   // Set new height
                        //     $(objImg).css("width", width * ratio);    // Scale width based on ratio
                        //     width = width * ratio;    // Reset width to match scaled image
                        //     height = height * ratio;    // Reset height to match scaled image
                        // }                        
                    }
                   
                } catch (e) {

                }
            };
            
            var GSet = function () {   
                var setObj = {}, val = {};
                this.count = 0;
                this.add = function (str) {
                    setObj[str] = val;
                    return ++this.count
                };
            
                this.contains = function (str) {
                    return setObj[str] === val;
                };
            
                this.remove = function (str) {
                    delete setObj[str];
                    return --this.count
                };
            
                this.values = function () {
                    var values = [];
                    for (var i in setObj) {
                        if (setObj[i] === val) {
                            values.push(i);
                        }
                    }
                    return values;
                };
            };

    </script>
    
    <!------------- Start: Processing Div---------------------------------------->
    <style>
        .slick-dots li.slick-active button:before, .slick-dots li button:before{
            color:#227E8A!important;
        }
        .slick-dots li button:hover, .slick-dots li button:focus{
            color:#227E8A!important;
        }
        .clsVirtualTourURL { cursor:pointer; }
        /* .clsimgset { height:200px !important;  } */
        .sldsAvailableUnit { margin:10px 0; }
               

        .clsfontsize { font-size: 1em; }
        .clsRatingReview {
            /* font-size: 1.2em; */
            margin-left: 5px;
        }
        /*.clsUnitURL { cursor: pointer;}*/
        .clsPrimayColor { color: #227E8A;  font-size: 1rem !important; }
        .clsfnt16 {  font-size: 1rem !important;  }
        .clsfnt14 {  font-size: 0.875rem !important;  }
        .slds-scope .slds-box { border:0 !important; }
        
        .slds-avatar--large {
            width: 5rem;
            height:5rem;
        }
        .fa-3 {
            font-size: 1.5em;
        }
        .image-upload > input {
            display: none;
        }
        .ProcessingBackground {
            background-color: #fff;
            opacity: 0.60;
            filter: alpha(opacity = 50);
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 9998;
            top:0;
            left:0;
        }
        .Processing {
            z-index: 9999;
            left: 47.5%;
            top: 50%;
            text-align: center;
            position: fixed;
        } 
        .slds-scope .slds-notify-container, .slds-scope .slds-notify_container{
            z-index:9000;
        }
        .slds-grid+.slds-grid {
            margin-top: 0.5rem;
        }
        .slds-grid+.slds-grid {
            margin-top: 0.5rem;
        }
        .slds-radio_button__label{
            border: 1px solid #ccc;
            border-radius: 0.25rem !important;
            /*color: rgb(0, 112, 210) !important;*/
            color: #227e8a !important;
        }
        .radioLabel{
            padding: 0px !important;
        }
        .uiBlock .bBody{
            white-space:pre-wrap;
        }
        /*.slds-accordion__summary-heading {
            font-weight: bold !important;
        }*/
        .slds-accordion__section {
            background-color: #FAFAFA !important;
            margin-bottom:5px;
            border-radius: 0.25rem!important;
        }
        /*body {
            overflow:unset !important;
        }*/
        .slds-radio_button [type=radio]:checked+.slds-radio_button__label{
            /*background-color: rgb(118, 158, 218) !important;*/
            /*background-color:rgb(98, 135, 191) !important;*/
            /*background-color: rgba(98, 191, 109, 0.92) !important;*/
            background-color: #227E8A !important;
            color:  rgb(255, 255, 255) !important;
        }
        .slds-radio_button [type=radio]+.slds-radio_button__label {
            font-family:'Open Sans', sans-serif !important;
        }
        .slds-radio_button [type=radio]:not(:checked)+.slds-radio_button__label:hover{
            background-color: rgb(244, 246, 249) !important;
        }
        .slds-page-header__title, .slds-card__header, #pcunit {
            color: #227E8A;
            font-family:Lato Light !important;
            /* font-size: 2rem !important; */
            /* font-size: 1.5vw !important; */
        }
        .slds-page-header {
            background: #FAFAFA !important;
        }
        .slds-card__header {
            padding-left: 1rem !important;
        }
        .slds-button--brand {
            background-color:#227E8A !important;
            text-transform: uppercase !important;
            font-family:Lato !important;
        }
        .slds-button--brand:hover {
            background-color:#1D6C78 !important;
        }
        .slds-button_neutral {
            background-color:#EAF5F4 !important;
            color:#1D6C78 !important;
            text-transform: uppercase !important;
            font-family:Lato !important;
        }
        .slds-button_neutral:disabled,.slds-button_neutral:disabled:hover {
            background-color:#71AEBB !important;
            color:#fff !important;
        }
        .slds-button_neutral:hover {
            background-color:#FAFAFA !important;
        }
        #aljs-prevButton, #aljs-nextButton {
            color: #71AEBB !important;
        }
        .slds-scope .slds-input-has-icon .slds-input__icon {
            fill:#71AEBB !important;
        }
        .slds-scope .slds-datepicker td.slds-is-selected:not(.slds-disabled-text)>.slds-day {
            background: #227E8A !important;
        }
        .slds-scope .slds-card {
            background: #FAFAFA;
            border: none;
        }
        .slds-section-title--divider,.slds-text-heading--medium, .detailFont, .slds-align-middle {
            font-family:'Open Sans', sans-serif !important;
        }
        .slds, .slds-scope, .slds-scope th, .slds-scope td {
            font-family:'Open Sans', sans-serif !important;
            color: #4A4A4A !important;
        }
        .slds-card__body {
            padding-bottom:0.5rem;
        }

        .headingFont{
            font-family:Lato Light !important;
        }

        .fancybox-slide {
            padding-left: 0px;
            padding-right: 0px;
        }

        .slick-prev {
            left: 0;
            z-index:1;
            color:transparent !important;
        }
        .slick-next {
            right: 0;
            color:transparent !important;
        }
        /*.slick-prev:before {
            content: '\F053' !important;
        }
        .slick-next:before {
            content: '\F054' !important;
        }*/
        .slick-prev:before, .slick-next:before{
            color: #227E8A;
        }

        .virtualTourcontainer{
            position:relative;
        }
        .virtualTourcontainer:hover{
            /* opacity:0.5; */ /* commented to remove opacity 3d tour*/
        }

        .virtualTourcontainer .virtualTourThumbnail{
            opacity: .7;
        }
        
        .virtualTourcontainer .playOverlay{
            position: absolute;
            /*top: 50%;
            left: 50%;*//* commented to remove opacity 3d tour*/
            bottom:10px;
            right:10px;
            /* transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%); *//* commented to remove opacity 3d tour*/
            
            color: white;
            font-size: 16px;
            /*padding: 12px 24px;
            background-color: #555;*/
            border: none;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
            /* height: 50px; *//* commented to remove opacity 3d tour*/
            width: 54px;
        }

         /* .slidermaxwidth { max-width: 354px;  }  */
        
        @media screen and (max-width: 1024px) {
           /* .clsimgset {
               height:200px!important;
           } */
           
        }

        @media screen and (max-width: 768px) {
           /* .clsimgset {
               height:170px!important;
           }       */
           .playOverlay { bottom:7px !important; right: 7px !important; width:44px !important; }
        
            /* .slds-page-header__title, .slds-card__header, #pcunit {
                font-size: 1.83314rem !important;
            }
            .clsPrimayColor {font-size: 1rem !important;} */
        }


        @media screen and (max-width: 480px) {
           /* .clsimgset {
               height:170px!important;
           } */
           .playOverlay { bottom:5px!important; right: 5px!important; width:50px!important; }
           
        }

        

        .slick-dots li {margin: 0 -5px!important; }

        .nounderline { text-decoration: none!important; }

        button.slds-button.slds-button--brand.btnNextToPayment.clsdisabledbtn {
            background: #f0f0f0!important;
            color: #000;
        }

        .clsContact { cursor: pointer; }
        
        .clsShowHideActivity { display:none;}
        
    </style>
    <div id="divProcessing" style="display:none;">
        <div class="ProcessingBackground"></div>
        <div class="Processing">           
            <image alt="Processing" width="64" height="64" src="{!URLFOR($Resource.lightning, '/assets/images/spinners/slds_spinner_brand.gif')}" />
        </div>
        <apex:actionStatus id="Processing" onstart="document.getElementById('divProcessing').style.display = '';" onstop="document.getElementById('divProcessing').style.display = 'none';">                            
        </apex:actionStatus>
    </div>  
    <!------------- End: Processing Div---------------------------------------->
</apex:page>